(window.webpackJsonp=window.webpackJsonp||[]).push([[75],{351:function(_,t,v){"use strict";v.r(t);var r=v(10),a=Object(r.a)({},(function(){var _=this,t=_._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("h1",{attrs:{id:"订单超时自动取消的三种方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#订单超时自动取消的三种方案"}},[_._v("#")]),_._v(" 订单超时自动取消的三种方案")]),_._v(" "),t("p",[_._v("大家对电商购物应该都比较熟悉了，我们应该注意到，在下单之后，通常会有一个倒计时，如果超过支付时间，订单就会被自动取消。")]),_._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/BXuan-Yang/blogImage/img/image-20230314091055425.png",alt:"image-20230314091055425"}})]),_._v(" "),t("h2",{attrs:{id:"_1-定时任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-定时任务"}},[_._v("#")]),_._v(" 1.定时任务")]),_._v(" "),t("p",[_._v("定时任务去轮询数据库，取消即将超时的订单")]),_._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/BXuan-Yang/blogImage/img/image-20230314091839704.png",alt:"image-20230314091839704"}})]),_._v(" "),t("p",[_._v("定时任务实现方式有很多种，大概可以分为两类："),t("code",[_._v("本地定时任务")]),_._v("和"),t("code",[_._v("分布式定时任务")]),_._v("。")]),_._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/BXuan-Yang/blogImage/img/640",alt:"图片"}})]),_._v(" "),t("p",[t("strong",[_._v("本地定时任务，适用于单机版的业务系统，实现方式非常多样：")])]),_._v(" "),t("ul",[t("li",[t("strong",[_._v("永动机线程")]),_._v("：开启一个线程，通过sleep去完成定时，一些开源中间件的某些定时任务是通过这种方式实现的。")]),_._v(" "),t("li",[t("strong",[_._v("JDK Timer")]),_._v("：JDK提供了Timer API，也提供了很多周期性的方法。")]),_._v(" "),t("li",[t("strong",[_._v("延迟线程池")]),_._v("：JDK还提供了延迟线程池ScheduledExecutorService，API和Timer类似。")]),_._v(" "),t("li",[t("strong",[_._v("Spring Task")]),_._v("：Sprig框架也提供了一些定时任务的实现，使用起来更加简单。")]),_._v(" "),t("li",[t("strong",[_._v("Quartz")]),_._v("：Quartz框架更进一步，提供了可以动态配置的线程池。")])]),_._v(" "),t("p",[t("strong",[_._v("分布式定时任务：适用于分布式的业务系统，主要的实现框架有两种：")])]),_._v(" "),t("ul",[t("li",[t("strong",[_._v("xxl-job")]),_._v("：大众点评的许雪里开源的，一款基于MySQL的轻量级分布式定时任务框架。")]),_._v(" "),t("li",[t("strong",[_._v("elastic-job")]),_._v("：当当开发的弹性分布式任务调度系统，功能很强大，相对重一些。")])]),_._v(" "),t("p",[_._v("定时任务实现的优点是开发起来比较简单，但是它也有一些缺点：")]),_._v(" "),t("ul",[t("li",[_._v("对数据库的压力很大，定时任务造成人为的波峰，执行的时刻数据库的压力会陡增")]),_._v(" "),t("li",[_._v("计时不准，定时任务做不到非常精确的时间控制，比如半小时订单过期，但是定时任务很难卡准这个点")])]),_._v(" "),t("h2",{attrs:{id:"_2-被动取消"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-被动取消"}},[_._v("#")]),_._v(" 2.被动取消")]),_._v(" "),t("p",[_._v("在文章开头的那个倒计时器，大家觉得是怎么做的呢？一般是客户端计时+服务端检查。")]),_._v(" "),t("p",[_._v("什么意思呢？就是这个倒计时由客户端去做，但是客户端定时去服务端检查，修正倒计时的时间。")]),_._v(" "),t("p",[_._v("那么，这个订单超时自动取消，也可以由客户端去做：")]),_._v(" "),t("ul",[t("li",[_._v("用户留在收银台的时候，客户端倒计时+主动查询订单状态，服务端每次都去检查一下订单是否超时、剩余时间")]),_._v(" "),t("li",[_._v("用户每次进入订单相关的页面，查询订单的时候，服务端也检查一下订单是否超时")])]),_._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/BXuan-Yang/blogImage/img/image-20230314092318227.png",alt:"image-20230314092318227"}})]),_._v(" "),t("p",[_._v("这种方式实现起来也比较简单，但是它也有缺点：")]),_._v(" "),t("ul",[t("li",[_._v("依赖客户端，如果客户端不发起请求，订单可能永远没法过期，一直占用库存")])]),_._v(" "),t("p",[_._v("当然，也可以"),t("code",[_._v("被动取消")]),_._v("+"),t("code",[_._v("定时任务")]),_._v("，通过定时任务去做兜底的操作。")]),_._v(" "),t("h2",{attrs:{id:"_3-延时消息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-延时消息"}},[_._v("#")]),_._v(" 3.延时消息")]),_._v(" "),t("p",[_._v("第三种方案，就是利用延时消息了，可以使用 "),t("strong",[_._v("RocketMQ、RabbitMQ、Kafka 的延时消息")]),_._v("，消息发送后，有一定延时才会投递。")]),_._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/PMZOEonJxWet6dkExtrdrG1hWr2LicsD4psG3CspMFIjcX7ShEG6SvNiaqI4LJ9LV7ElrFsWE9sWfZXZrjnBE6OA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),_._v("延时消息")]),_._v(" "),t("p",[_._v("我们用的就是这种，消息队列采用的是RocketMQ，其实RocketMQ延时也是利用定时任务实现的。")]),_._v(" "),t("p",[_._v("使用延时消息的优点是比较高效、好扩展，缺点是引入了新的技术组件，增加了复杂度。")]),_._v(" "),t("hr"),_._v(" "),t("p",[_._v("除了上面的三种，其实还有一些其它的方式，例如本地延迟队列、时间轮算法、Redis过期监听……")]),_._v(" "),t("p",[_._v("但是我觉得，应该不会有人真考虑过在生产上使用这些方法。")]),_._v(" "),t("h4",{attrs:{id:"相关阅读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#相关阅读"}},[_._v("#")]),_._v(" 相关阅读")]),_._v(" "),t("p",[t("a",{attrs:{href:"https://mp.weixin.qq.com/s/Z-ZnrqvzYIqxNY9lKVg47Q",target:"_blank",rel:"noopener noreferrer"}},[_._v("订单超时自动取消的 3 种解决方案，yyds！"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=a.exports}}]);