<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JUC | BXuanéšç¬”</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="æ¬¢è¿æ¥åˆ° BXuan çš„âœ¨ä¸ªäººç½‘ç«™âœ¨ğŸ‘ğŸ‘ğŸ‘ï¼">
    
    <link rel="preload" href="/assets/css/0.styles.72717b73.css" as="style"><link rel="preload" href="/assets/js/app.c7952645.js" as="script"><link rel="preload" href="/assets/js/2.53ba99d7.js" as="script"><link rel="preload" href="/assets/js/47.21cbd519.js" as="script"><link rel="prefetch" href="/assets/js/10.4ab63f7a.js"><link rel="prefetch" href="/assets/js/11.982bd386.js"><link rel="prefetch" href="/assets/js/12.0b6105e0.js"><link rel="prefetch" href="/assets/js/13.0b88c945.js"><link rel="prefetch" href="/assets/js/14.32b6e670.js"><link rel="prefetch" href="/assets/js/15.1651a6b7.js"><link rel="prefetch" href="/assets/js/16.55e08c05.js"><link rel="prefetch" href="/assets/js/17.6d98ee08.js"><link rel="prefetch" href="/assets/js/18.fc4ae118.js"><link rel="prefetch" href="/assets/js/19.ea630d0e.js"><link rel="prefetch" href="/assets/js/20.6151654c.js"><link rel="prefetch" href="/assets/js/21.1ddadd96.js"><link rel="prefetch" href="/assets/js/22.6e312c0e.js"><link rel="prefetch" href="/assets/js/23.ab691b41.js"><link rel="prefetch" href="/assets/js/24.6667f20a.js"><link rel="prefetch" href="/assets/js/25.517e4303.js"><link rel="prefetch" href="/assets/js/26.c92294b8.js"><link rel="prefetch" href="/assets/js/27.30245c81.js"><link rel="prefetch" href="/assets/js/28.83f84f64.js"><link rel="prefetch" href="/assets/js/29.2ebf177e.js"><link rel="prefetch" href="/assets/js/3.c16bd42d.js"><link rel="prefetch" href="/assets/js/30.15f1115b.js"><link rel="prefetch" href="/assets/js/31.271bb831.js"><link rel="prefetch" href="/assets/js/32.a3ffc84b.js"><link rel="prefetch" href="/assets/js/33.837c492d.js"><link rel="prefetch" href="/assets/js/34.6535b864.js"><link rel="prefetch" href="/assets/js/35.a9f35d11.js"><link rel="prefetch" href="/assets/js/36.58c71fa7.js"><link rel="prefetch" href="/assets/js/37.536c34aa.js"><link rel="prefetch" href="/assets/js/38.dca08340.js"><link rel="prefetch" href="/assets/js/39.20e843ec.js"><link rel="prefetch" href="/assets/js/4.d6c515d3.js"><link rel="prefetch" href="/assets/js/40.f33282da.js"><link rel="prefetch" href="/assets/js/41.0afdb83a.js"><link rel="prefetch" href="/assets/js/42.68f5e469.js"><link rel="prefetch" href="/assets/js/43.65a3e240.js"><link rel="prefetch" href="/assets/js/44.0429a345.js"><link rel="prefetch" href="/assets/js/45.61c6d807.js"><link rel="prefetch" href="/assets/js/46.69ea8e4b.js"><link rel="prefetch" href="/assets/js/48.b46e7243.js"><link rel="prefetch" href="/assets/js/49.8f93a744.js"><link rel="prefetch" href="/assets/js/5.65846da7.js"><link rel="prefetch" href="/assets/js/50.323a9f2b.js"><link rel="prefetch" href="/assets/js/51.731382e7.js"><link rel="prefetch" href="/assets/js/52.429c91e1.js"><link rel="prefetch" href="/assets/js/53.6ad30434.js"><link rel="prefetch" href="/assets/js/54.c2c209db.js"><link rel="prefetch" href="/assets/js/55.36509a79.js"><link rel="prefetch" href="/assets/js/56.442c1774.js"><link rel="prefetch" href="/assets/js/57.104714c1.js"><link rel="prefetch" href="/assets/js/58.d1eb3d61.js"><link rel="prefetch" href="/assets/js/59.7642ee42.js"><link rel="prefetch" href="/assets/js/6.1cca85df.js"><link rel="prefetch" href="/assets/js/60.497110a7.js"><link rel="prefetch" href="/assets/js/61.9456cece.js"><link rel="prefetch" href="/assets/js/62.4acf84cc.js"><link rel="prefetch" href="/assets/js/63.649869e0.js"><link rel="prefetch" href="/assets/js/64.a9a2a5e7.js"><link rel="prefetch" href="/assets/js/65.caf50992.js"><link rel="prefetch" href="/assets/js/66.a082df91.js"><link rel="prefetch" href="/assets/js/67.77906dd6.js"><link rel="prefetch" href="/assets/js/68.b187b7a3.js"><link rel="prefetch" href="/assets/js/69.d4e466ec.js"><link rel="prefetch" href="/assets/js/7.e19e61cb.js"><link rel="prefetch" href="/assets/js/70.d3e767af.js"><link rel="prefetch" href="/assets/js/71.b195f372.js"><link rel="prefetch" href="/assets/js/72.394bd04d.js"><link rel="prefetch" href="/assets/js/73.cca17919.js"><link rel="prefetch" href="/assets/js/74.91e1d2ef.js"><link rel="prefetch" href="/assets/js/75.6f26e213.js"><link rel="prefetch" href="/assets/js/76.9ae90df7.js"><link rel="prefetch" href="/assets/js/77.1220dc5d.js"><link rel="prefetch" href="/assets/js/78.d80a520f.js"><link rel="prefetch" href="/assets/js/79.d22d4bb9.js"><link rel="prefetch" href="/assets/js/8.c222cd7c.js"><link rel="prefetch" href="/assets/js/9.55b8fde2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.72717b73.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="BXuanéšç¬”" class="logo"> <span class="site-name can-hide">BXuanéšç¬”</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="è®¡ç®—æœºåŸºç¡€" class="dropdown-title"><span class="title">è®¡ç®—æœºåŸºç¡€</span> <span class="arrow down"></span></button> <button type="button" aria-label="è®¡ç®—æœºåŸºç¡€" class="mobile-dropdown-title"><span class="title">è®¡ç®—æœºåŸºç¡€</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/network/" class="nav-link">
  ğŸ”è®¡ç®—æœºç½‘ç»œ
</a></li><li class="dropdown-item"><!----> <a href="/blog/os/" class="nav-link">
  ğŸŸæ“ä½œç³»ç»Ÿ
</a></li><li class="dropdown-item"><!----> <a href="/blog/algo/" class="nav-link">
  ğŸ•æ•°æ®ç»“æ„ä¸ç®—æ³•
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç¼–ç¨‹è¯­è¨€" class="dropdown-title"><span class="title">ç¼–ç¨‹è¯­è¨€</span> <span class="arrow down"></span></button> <button type="button" aria-label="ç¼–ç¨‹è¯­è¨€" class="mobile-dropdown-title"><span class="title">ç¼–ç¨‹è¯­è¨€</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/" class="nav-link router-link-active">
  ğŸŒ­Java
</a></li><li class="dropdown-item"><!----> <a href="/blog/go/" class="nav-link">
  ğŸ¿Go
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="è½¯ä»¶å¼€å‘" class="dropdown-title"><span class="title">è½¯ä»¶å¼€å‘</span> <span class="arrow down"></span></button> <button type="button" aria-label="è½¯ä»¶å¼€å‘" class="mobile-dropdown-title"><span class="title">è½¯ä»¶å¼€å‘</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          ğŸŒ®æ•°æ®åº“
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-subitem"><a href="/blog/redis/" class="nav-link">
  Redis
</a></li></ul></li><li class="dropdown-item"><h4>
          ğŸ¥ªå¼€å‘æ¡†æ¶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/frame/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-subitem"><a href="/blog/frame/springboot/" class="nav-link">
  SpringBoot
</a></li></ul></li><li class="dropdown-item"><h4>
          ğŸ¥Ÿæ¶æ„è®¾è®¡
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/schemadesigner/" class="nav-link">
  è®¾è®¡æ¨¡å¼
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="è½¯ä»¶æµ‹è¯•" class="dropdown-title"><span class="title">è½¯ä»¶æµ‹è¯•</span> <span class="arrow down"></span></button> <button type="button" aria-label="è½¯ä»¶æµ‹è¯•" class="mobile-dropdown-title"><span class="title">è½¯ä»¶æµ‹è¯•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/softwaretest/baseOfSoftwareTest/" class="nav-link">
  ğŸ¥“è½¯ä»¶æµ‹è¯•åŸºç¡€
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æ–‡ç« é˜…è¯»" class="dropdown-title"><span class="title">æ–‡ç« é˜…è¯»</span> <span class="arrow down"></span></button> <button type="button" aria-label="æ–‡ç« é˜…è¯»" class="mobile-dropdown-title"><span class="title">æ–‡ç« é˜…è¯»</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/interview/all.html" class="nav-link">
  ğŸ’ªé¢ç»æ±‡æ€»
</a></li><li class="dropdown-item"><!----> <a href="/blog/other/" class="nav-link">
  ğŸ§€å…¶ä»–é˜…è¯»
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/BXuan-Yang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GithubğŸ™‹â€â™‚ï¸
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="è®¡ç®—æœºåŸºç¡€" class="dropdown-title"><span class="title">è®¡ç®—æœºåŸºç¡€</span> <span class="arrow down"></span></button> <button type="button" aria-label="è®¡ç®—æœºåŸºç¡€" class="mobile-dropdown-title"><span class="title">è®¡ç®—æœºåŸºç¡€</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/network/" class="nav-link">
  ğŸ”è®¡ç®—æœºç½‘ç»œ
</a></li><li class="dropdown-item"><!----> <a href="/blog/os/" class="nav-link">
  ğŸŸæ“ä½œç³»ç»Ÿ
</a></li><li class="dropdown-item"><!----> <a href="/blog/algo/" class="nav-link">
  ğŸ•æ•°æ®ç»“æ„ä¸ç®—æ³•
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç¼–ç¨‹è¯­è¨€" class="dropdown-title"><span class="title">ç¼–ç¨‹è¯­è¨€</span> <span class="arrow down"></span></button> <button type="button" aria-label="ç¼–ç¨‹è¯­è¨€" class="mobile-dropdown-title"><span class="title">ç¼–ç¨‹è¯­è¨€</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/" class="nav-link router-link-active">
  ğŸŒ­Java
</a></li><li class="dropdown-item"><!----> <a href="/blog/go/" class="nav-link">
  ğŸ¿Go
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="è½¯ä»¶å¼€å‘" class="dropdown-title"><span class="title">è½¯ä»¶å¼€å‘</span> <span class="arrow down"></span></button> <button type="button" aria-label="è½¯ä»¶å¼€å‘" class="mobile-dropdown-title"><span class="title">è½¯ä»¶å¼€å‘</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          ğŸŒ®æ•°æ®åº“
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-subitem"><a href="/blog/redis/" class="nav-link">
  Redis
</a></li></ul></li><li class="dropdown-item"><h4>
          ğŸ¥ªå¼€å‘æ¡†æ¶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/frame/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-subitem"><a href="/blog/frame/springboot/" class="nav-link">
  SpringBoot
</a></li></ul></li><li class="dropdown-item"><h4>
          ğŸ¥Ÿæ¶æ„è®¾è®¡
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/schemadesigner/" class="nav-link">
  è®¾è®¡æ¨¡å¼
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="è½¯ä»¶æµ‹è¯•" class="dropdown-title"><span class="title">è½¯ä»¶æµ‹è¯•</span> <span class="arrow down"></span></button> <button type="button" aria-label="è½¯ä»¶æµ‹è¯•" class="mobile-dropdown-title"><span class="title">è½¯ä»¶æµ‹è¯•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/softwaretest/baseOfSoftwareTest/" class="nav-link">
  ğŸ¥“è½¯ä»¶æµ‹è¯•åŸºç¡€
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æ–‡ç« é˜…è¯»" class="dropdown-title"><span class="title">æ–‡ç« é˜…è¯»</span> <span class="arrow down"></span></button> <button type="button" aria-label="æ–‡ç« é˜…è¯»" class="mobile-dropdown-title"><span class="title">æ–‡ç« é˜…è¯»</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/interview/all.html" class="nav-link">
  ğŸ’ªé¢ç»æ±‡æ€»
</a></li><li class="dropdown-item"><!----> <a href="/blog/other/" class="nav-link">
  ğŸ§€å…¶ä»–é˜…è¯»
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/BXuan-Yang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GithubğŸ™‹â€â™‚ï¸
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/java/JavaBase.html" class="sidebar-link">JavaåŸºç¡€</a></li><li><a href="/blog/java/JavaGather.html" class="sidebar-link">Java é›†åˆ</a></li><li><a href="/blog/java/JUC.html" aria-current="page" class="active sidebar-link">JUC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#jucç®€ä»‹" class="sidebar-link">JUCç®€ä»‹</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#volatileå…³é”®å­—-å†…å­˜å¯è§æ€§" class="sidebar-link">volatileå…³é”®å­— - å†…å­˜å¯è§æ€§</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åŸå­å˜é‡ä¸casç®—æ³•" class="sidebar-link">åŸå­å˜é‡ä¸CASç®—æ³•</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_1ã€i-çš„åŸå­æ€§é—®é¢˜" class="sidebar-link">1ã€i++çš„åŸå­æ€§é—®é¢˜</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_2ã€åŸå­å˜é‡" class="sidebar-link">2ã€åŸå­å˜é‡</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_3ã€casç®—æ³•" class="sidebar-link">3ã€CASç®—æ³•</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#äº”ã€countdowmlatch-é—­é”" class="sidebar-link">äº”ã€CountDowmLatch é—­é”</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#å…­ã€å®ç°callableæ¥å£" class="sidebar-link">å…­ã€å®ç°Callableæ¥å£</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#ä¸ƒã€lockåŒæ­¥é”" class="sidebar-link">ä¸ƒã€LockåŒæ­¥é”</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#å…«ã€condition-æ§åˆ¶çº¿ç¨‹é€šä¿¡" class="sidebar-link">å…«ã€Condition æ§åˆ¶çº¿ç¨‹é€šä¿¡</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#ä¹ã€çº¿ç¨‹å…«é”" class="sidebar-link">ä¹ã€çº¿ç¨‹å…«é”</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åã€çº¿ç¨‹æŒ‰åºäº¤æ›¿" class="sidebar-link">åã€çº¿ç¨‹æŒ‰åºäº¤æ›¿</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åä¸€ã€readwritelock-è¯»å†™é”" class="sidebar-link">åä¸€ã€ReadWritelock è¯»å†™é”</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åäºŒã€çº¿ç¨‹æ± " class="sidebar-link">åäºŒã€çº¿ç¨‹æ± </a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åä¸‰ã€çº¿ç¨‹è°ƒåº¦" class="sidebar-link">åä¸‰ã€çº¿ç¨‹è°ƒåº¦</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åå››ã€forkjoinpool-åˆ†æ”¯-åˆå¹¶æ¡†æ¶-å·¥ä½œçªƒå–" class="sidebar-link">åå››ã€ForkJoinPool åˆ†æ”¯/åˆå¹¶æ¡†æ¶ å·¥ä½œçªƒå–</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#å¹¶å‘å·¥å…·ç±»" class="sidebar-link">å¹¶å‘å·¥å…·ç±»</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#countdownlatch-ç­‰å¾…å¤šçº¿ç¨‹å®Œæˆ" class="sidebar-link">CountDownLatch ç­‰å¾…å¤šçº¿ç¨‹å®Œæˆ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#cyclicbarrier-åŒæ­¥å±éšœ" class="sidebar-link">CyclicBarrier åŒæ­¥å±éšœ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#semaphore-æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°" class="sidebar-link">Semaphore æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#çº¿ç¨‹é—´äº¤æ¢æ•°æ®-exchanger" class="sidebar-link">çº¿ç¨‹é—´äº¤æ¢æ•°æ® Exchanger</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#javaå¹¶å‘çš„åº•å±‚å®ç°æœºåˆ¶" class="sidebar-link">Javaå¹¶å‘çš„åº•å±‚å®ç°æœºåˆ¶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#volatile-çš„åº”ç”¨" class="sidebar-link">Volatile çš„åº”ç”¨</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#synchronized-çš„å®ç°åŸç†ä¸åº”ç”¨" class="sidebar-link">synchronized çš„å®ç°åŸç†ä¸åº”ç”¨</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#ç®¡ç¨‹" class="sidebar-link">ç®¡ç¨‹</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#synchronziedçš„åº•å±‚åŸç†" class="sidebar-link">Synchronziedçš„åº•å±‚åŸç†</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#ç›¸å…³é“¾æ¥" class="sidebar-link">ç›¸å…³é“¾æ¥</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åˆ†å¸ƒå¼é”" class="sidebar-link">åˆ†å¸ƒå¼é”</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åˆ†å¸ƒå¼é”çš„ç‰¹å¾" class="sidebar-link">åˆ†å¸ƒå¼é”çš„ç‰¹å¾</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åˆ†å¸ƒå¼é”çš„å®ç°" class="sidebar-link">åˆ†å¸ƒå¼é”çš„å®ç°</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åˆ†å¸ƒå¼é”-2" class="sidebar-link">åˆ†å¸ƒå¼é”</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”" class="sidebar-link">åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#åŸºäºrediså®ç°åˆ†å¸ƒå¼é”" class="sidebar-link">åŸºäºRediså®ç°åˆ†å¸ƒå¼é”</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#zookeeperåˆ†å¸ƒå¼é”" class="sidebar-link">Zookeeperåˆ†å¸ƒå¼é”</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_5-ä¸‰ç§åˆ†å¸ƒå¼é”å¯¹æ¯”" class="sidebar-link">5. ä¸‰ç§åˆ†å¸ƒå¼é”å¯¹æ¯”</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#çº¿ç¨‹æ± " class="sidebar-link">çº¿ç¨‹æ± </a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#çº¿ç¨‹æ± çš„ä½œç”¨" class="sidebar-link">çº¿ç¨‹æ± çš„ä½œç”¨</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#å½“ä¸€ä¸ªæ–°ä»»åŠ¡åˆ°è¾¾çº¿ç¨‹æ± æ—¶-å…¶å¤„ç†æµç¨‹" class="sidebar-link">å½“ä¸€ä¸ªæ–°ä»»åŠ¡åˆ°è¾¾çº¿ç¨‹æ± æ—¶ï¼Œå…¶å¤„ç†æµç¨‹ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#ä»‹ç»ä¸€ä¸‹çº¿ç¨‹æ± çš„å‚æ•°" class="sidebar-link">ä»‹ç»ä¸€ä¸‹çº¿ç¨‹æ± çš„å‚æ•°</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#çº¿ç¨‹æ± æœ‰å“ªäº›é¥±å’Œç­–ç•¥" class="sidebar-link">çº¿ç¨‹æ± æœ‰å“ªäº›é¥±å’Œç­–ç•¥ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#çº¿ç¨‹æ± å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›" class="sidebar-link">çº¿ç¨‹æ± å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#å¦‚ä½•å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡" class="sidebar-link">å¦‚ä½•å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#å¦‚ä½•å…³é—­çº¿ç¨‹æ± " class="sidebar-link">å¦‚ä½•å…³é—­çº¿ç¨‹æ± ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#å¦‚ä½•åˆç†çš„é…ç½®çº¿ç¨‹æ± " class="sidebar-link">å¦‚ä½•åˆç†çš„é…ç½®çº¿ç¨‹æ± ï¼Ÿ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#å¦‚ä½•å¯¹çº¿ç¨‹æ± è¿›è¡Œç›‘æ§" class="sidebar-link">å¦‚ä½•å¯¹çº¿ç¨‹æ± è¿›è¡Œç›‘æ§ï¼Ÿ</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#concurrenthashmap" class="sidebar-link">ConcurrentHashMap</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#ç®€å•ä»‹ç»ä¸€ä¸‹-concurrenthashmap" class="sidebar-link">ç®€å•ä»‹ç»ä¸€ä¸‹ ConcurrentHashMap</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#concurrenthashmap-å®ç°åŸç†" class="sidebar-link">ConcurrentHashMap å®ç°åŸç†</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#å¤šçº¿ç¨‹" class="sidebar-link">å¤šçº¿ç¨‹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_1ã€ç¨‹åºã€è¿›ç¨‹ã€çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ" class="sidebar-link">1ã€ç¨‹åºã€è¿›ç¨‹ã€çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_2ã€å¹¶å‘ä¸å¹¶è¡Œ" class="sidebar-link">2ã€å¹¶å‘ä¸å¹¶è¡Œ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_3ã€å¤šçº¿ç¨‹çš„ä¼˜ç‚¹" class="sidebar-link">3ã€å¤šçº¿ç¨‹çš„ä¼˜ç‚¹</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_4ã€javaä¸­å¤šçº¿ç¨‹" class="sidebar-link">4ã€Javaä¸­å¤šçº¿ç¨‹</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_5ã€çº¿ç¨‹çš„è°ƒåº¦" class="sidebar-link">5ã€çº¿ç¨‹çš„è°ƒåº¦</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_6ã€çº¿ç¨‹çš„åˆ†ç±»" class="sidebar-link">6ã€çº¿ç¨‹çš„åˆ†ç±»</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_7ã€çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ" class="sidebar-link">7ã€çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_8ã€synchronizedçš„ä½¿ç”¨æ–¹æ³•" class="sidebar-link">8ã€Synchronizedçš„ä½¿ç”¨æ–¹æ³•</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_9ã€åŒæ­¥é”æœºåˆ¶" class="sidebar-link">9ã€åŒæ­¥é”æœºåˆ¶</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_10ã€synchronizedé”" class="sidebar-link">10ã€synchronizedé”</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_11ã€locké”" class="sidebar-link">11ã€Locké”</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_12ã€synchronizedä¸lockçš„å¯¹æ¯”" class="sidebar-link">12ã€synchronizedä¸Lockçš„å¯¹æ¯”</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_13ã€çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡" class="sidebar-link">13ã€çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_14ã€wait-ä¸-notify-å’Œ-notifyall" class="sidebar-link">14ã€wait() ä¸ notify() å’Œ notifyAll()</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_15ã€callableæ¥å£" class="sidebar-link">15ã€Callableæ¥å£</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_16ã€ä½¿ç”¨çº¿ç¨‹æ± åŠçº¿ç¨‹æ± ç›¸å…³api" class="sidebar-link">16ã€ä½¿ç”¨çº¿ç¨‹æ± åŠçº¿ç¨‹æ± ç›¸å…³API</a></li><li class="sidebar-sub-header"><a href="/blog/java/JUC.html#_17ã€çº¿ç¨‹æ± ç›¸å…³api" class="sidebar-link">17ã€çº¿ç¨‹æ± ç›¸å…³API</a></li></ul></li></ul></li><li><a href="/blog/java/JVM.html" class="sidebar-link">JVM</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="juc"><a href="#juc" class="header-anchor">#</a> JUC</h1> <h2 id="jucç®€ä»‹"><a href="#jucç®€ä»‹" class="header-anchor">#</a> JUCç®€ä»‹</h2> <p>åˆç†åˆ©ç”¨å¤šçº¿ç¨‹</p> <p>å¤šçº¿ç¨‹çš„ç›®çš„ï¼šæé«˜æ•ˆç‡ï¼Œå°½å¯èƒ½åœ°åˆ©ç”¨CPUçš„èµ„æº</p> <h2 id="volatileå…³é”®å­—-å†…å­˜å¯è§æ€§"><a href="#volatileå…³é”®å­—-å†…å­˜å¯è§æ€§" class="header-anchor">#</a> volatileå…³é”®å­— - å†…å­˜å¯è§æ€§</h2> <p><strong>å†…å­˜å¯è§æ€§æ˜¯æŒ‡ï¼Œå½“å¤šä¸ªçº¿ç¨‹æ“ä½œå…±äº«æ•°æ®æ—¶ï¼Œå½¼æ­¤ä¸å¯è§ã€‚ï¼ˆJVMä¸»å­˜é—®é¢˜ï¼‰</strong></p> <p>volatileå…³é”®å­—ä¿è¯å¤šä¸ªçº¿ç¨‹è®¿é—®æ•°æ®æ—¶ï¼Œ<strong>å…±äº«æ•°æ®åœ¨å†…å­˜ä¸­æ˜¯ç›¸äº’å¯è§çš„ã€‚</strong>ï¼ˆå¯ä»¥ç†è§£ä¸ºå­çº¿ç¨‹ç›´æ¥å¯¹ä¸»å­˜ä¸­çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œæ•ˆç‡ä¼šé™ä½ï¼Œä½†æ˜¯æ¯”é”çš„æ•ˆç‡é«˜ï¼Œä¸»è¦æ˜¯ä½åœ¨é‡æ’åºä¼˜åŒ–ï¼Œä¸èƒ½é‡æ’åºï¼‰ã€‚</p> <p><strong>ç›¸è¾ƒäºsynchronizedï¼ˆäº’æ–¥é”ï¼‰ï¼Œvolatileåªæ˜¯ä¸€ç§è¾ƒè½»é‡çº§çš„åŒæ­¥ç­–ç•¥ã€‚</strong></p> <p>æ³¨æ„ï¼š</p> <ol><li>volatile ä¸å…·å¤‡äº’æ–¥æ€§ã€‚</li> <li>volatile ä¸èƒ½ä¿è¯å˜é‡çš„åŸå­æ€§</li></ol> <p>ä¸‹é¢ç¼–å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç”¨ä¾‹æ„Ÿå—ä¸€ä¸‹volatileå¸¦æ¥çš„å½±å“ï¼</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestVolatile</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadDemo</span> threadDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>threadDemo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// ä½¿ç”¨åŒæ­¥é”è§£å†³é—®é¢˜ï¼Œæ¯æ¬¡éƒ½èƒ½åˆ·æ–°ç¼“å­˜ã€‚ä½†æ˜¯ï¼Œç”¨é”çš„è¯æ•ˆç‡ä¼šé™ä½ï¼Œå‡è®¾å¤šçº¿ç¨‹è®¿é—®çš„è¯ï¼Œæ¯æ¬¡éƒ½éœ€è¦å»åˆ¤æ–­é”ï¼Œæ•ˆç‡æ€¥å‰§ä¸‹é™ã€‚</span>
<span class="token comment">//            synchronized (threadDemo){</span>
<span class="token comment">//                if (threadDemo.isFlag()){</span>
<span class="token comment">//                    System.out.println(&quot;***************&quot;);</span>
<span class="token comment">//                    break;</span>
<span class="token comment">//                }</span>
<span class="token comment">//            }</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>threadDemo<span class="token punctuation">.</span><span class="token function">isFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;***************&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ›å»ºçº¿ç¨‹demo</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadDemo</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFlag</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å¢åŠ volatileå…³é”®å­—ï¼Œè§£å†³å¤šçº¿ç¨‹æ•°æ®å…±äº«é—®é¢˜</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;flag:&quot;</span> <span class="token operator">+</span> <span class="token function">isFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="åŸå­å˜é‡ä¸casç®—æ³•"><a href="#åŸå­å˜é‡ä¸casç®—æ³•" class="header-anchor">#</a> åŸå­å˜é‡ä¸CASç®—æ³•</h2> <h3 id="_1ã€i-çš„åŸå­æ€§é—®é¢˜"><a href="#_1ã€i-çš„åŸå­æ€§é—®é¢˜" class="header-anchor">#</a> 1ã€i++çš„åŸå­æ€§é—®é¢˜</h3> <p>é’ˆå¯¹äºç®€å•çš„i++æ“ä½œï¼Œå¾ˆå¤šåŒå­¦è¿˜ä¸çŸ¥é“å†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ã€‚é‚£ä¹ˆä¸‹é¢æ˜¯i++çš„å†…éƒ¨å®ç°åŸç†</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
i <span class="token operator">=</span> i<span class="token operator">++</span><span class="token punctuation">;</span>

<span class="token operator">=</span><span class="token operator">&gt;</span>
<span class="token keyword">int</span> temp <span class="token operator">=</span> i<span class="token punctuation">;</span>
i <span class="token operator">=</span> i  <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
i <span class="token operator">=</span> temp<span class="token punctuation">;</span>
</code></pre></div><h3 id="_2ã€åŸå­å˜é‡"><a href="#_2ã€åŸå­å˜é‡" class="header-anchor">#</a> 2ã€åŸå­å˜é‡</h3> <p>jdk1.5 å java.util.concurrent.atomic åŒ…ä¸‹æä¾›äº†å¸¸ç”¨çš„åŸå­å˜é‡</p> <p><strong>ç‰¹ç‚¹ï¼š</strong></p> <ol><li>volatile ç‰¹å¾ï¼Œä¿è¯å†…å­˜å¯è§æ€§</li> <li><strong>CASç®—æ³•ï¼Œä¿è¯æ•°æ®çš„åŸå­æ€§</strong>ã€‚CASç®—æ³•æ˜¯ç¡¬ä»¶å¯¹äºå¹¶å‘æ“ä½œå…±äº«æ•°æ®çš„æ”¯æŒã€‚CASåŒ…å«äº†ä¸‰ä¸ªæ“ä½œ
<ol><li>å†…å­˜å€¼ V</li> <li>é¢„ä¼°å€¼ A</li> <li>æ›´æ–°å€¼ Bï¼Œå½“ä¸”ä»…å½“ V==Aæ—¶ï¼ŒV = B;</li></ol></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestAtomicDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadTest</span> threadTest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>threadTest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ThreadTest</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> atomicInteger<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3ã€casç®—æ³•"><a href="#_3ã€casç®—æ³•" class="header-anchor">#</a> 3ã€CASç®—æ³•</h3> <p>CASç®—æ³•æ˜¯ç¡¬ä»¶å¯¹äºå¹¶å‘æ“ä½œå…±äº«æ•°æ®çš„æ”¯æŒã€‚æ˜¯ä¸€ç§æ— é”çš„éé˜»å¡çš„ç®—æ³•çš„å®ç°ã€‚</p> <p>CASåŒ…å«äº†ä¸‰ä¸ªæ“ä½œï¼š</p> <ol><li>å†…å­˜å€¼ V</li> <li>é¢„ä¼°å€¼ A</li> <li>æ›´æ–°å€¼ Bï¼Œå½“ä¸”ä»…å½“ V==Aæ—¶ï¼ŒV = B;</li></ol> <h2 id="äº”ã€countdowmlatch-é—­é”"><a href="#äº”ã€countdowmlatch-é—­é”" class="header-anchor">#</a> äº”ã€CountDowmLatch é—­é”</h2> <p><strong>CountDowmLatchæ˜¯ä¸€ä¸ªåŒæ­¥è¾…åŠ©ç±»ã€‚åœ¨å®Œæˆä¸€ç»„æ­£åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œä¹‹å‰ï¼Œå®ƒå…è®¸ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ä¸€ç›´ç­‰å¾…ã€‚</strong></p> <p>é—­é”å¯ä»¥å»¶è¿Ÿçº¿ç¨‹çš„è¿›åº¦ç›´åˆ°å…¶åˆ°è¾¾ç»ˆæ­¢çŠ¶æ€ï¼Œé—­é”å¯ä»¥ç”¨æ¥ç¡®ä¿æŸäº›æ´»åŠ¨ç›´åˆ°å…¶ä»–æ´»åŠ¨éƒ½å®Œæˆæ—¶æ‰ç»§ç»­æ‰§è¡Œ</p> <ul><li>ç¡®ä¿æŸä¸ªè®¡ç®—åœ¨å…¶éœ€è¦çš„æ‰€æœ‰èµ„æºéƒ½è¢«åˆå§‹åŒ–ä¹‹åæ‰ç»§ç»­æ‰§è¡Œ</li> <li>ç¡®ä¿æŸä¸ªæœåŠ¡åœ¨å…¶ä¾èµ–çš„æ‰€æœ‰å…¶ä»–æœåŠ¡éƒ½å·²ç»å¯åŠ¨ä¹‹åæ‰å¯åŠ¨</li> <li>ç­‰å¾…ç›´åˆ°æŸä¸ªæ“ä½œæ‰€æœ‰å‚ä¸è€…éƒ½å‡†å¤‡å°±ç»ªå†ç»§ç»­è¿›è¡Œæ“ä½œ</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestCountDownLatch</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadCountDownLatch</span> threadCountDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadCountDownLatch</span><span class="token punctuation">(</span>countDownLatch<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>threadCountDownLatch<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è€—æ—¶æ—¶é—´ä¸ºï¼š&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadCountDownLatch</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> countDownLatch<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ThreadCountDownLatch</span><span class="token punctuation">(</span><span class="token class-name">CountDownLatch</span> countDownLatch<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>countDownLatch <span class="token operator">=</span> countDownLatch<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="å…­ã€å®ç°callableæ¥å£"><a href="#å…­ã€å®ç°callableæ¥å£" class="header-anchor">#</a> å…­ã€å®ç°Callableæ¥å£</h2> <p>åˆ›å»ºæ‰§è¡Œçº¿ç¨‹çš„æ–¹å¼ä¸‰ï¼šå®ç°Callableæ¥å£</p> <p>ç›¸è¾ƒäºå®ç°Runnable æ¥å£çš„æ–¹å¼ï¼Œæ–¹æ³•å¯ä»¥æœ‰è¿”å›å€¼ï¼Œå¹¶ä¸”å¯ä»¥æŠ›å‡ºå¼‚å¸¸</p> <p>æ‰§è¡ŒCallable æ–¹å¼ï¼Œéœ€è¦FutureTask å®ç°ç±»çš„æ”¯æŒï¼Œç”¨äºæ¥æ”¶è¿ç®—ç»“æœã€‚FutureTask æ˜¯Futureæ¥å£çš„å®ç°ç±»</p> <p>ä¸‹é¢ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­æ„Ÿå—ä¸€ä¸‹å¦‚ä½•å®ç°Callable</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestCallable</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadDemo02</span> threadDemo02 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadDemo02</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ‰§è¡ŒCallable æ–¹å¼ï¼Œéœ€è¦FutureTask å®ç°ç±»çš„æ”¯æŒï¼Œç”¨äºæ¥æ”¶è¿ç®—ç»“æœ</span>
        <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> futureTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>threadDemo02<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// FutureTask å¯ä»¥ç”¨äº é—­é”</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> integer <span class="token operator">=</span> futureTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ThreadDemo02</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//            System.out.println(i);</span>
            sum <span class="token operator">+=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ä¸ƒã€lockåŒæ­¥é”"><a href="#ä¸ƒã€lockåŒæ­¥é”" class="header-anchor">#</a> ä¸ƒã€LockåŒæ­¥é”</h2> <p>è§£å†³å¤šçº¿ç¨‹ä»£ç å—çš„æ–¹æ³•</p> <ol><li>åŒæ­¥ä»£ç å—</li> <li>åŒæ­¥æ–¹æ³•</li> <li><strong>åŒæ­¥é”</strong></li></ol> <p>1 2éƒ½éœ€è¦synchronizedï¼Œéšå¼é”</p> <p>3 éœ€è¦Lockï¼Œæ˜¾å¼é”ï¼Œé€šè¿‡lock()æ–¹æ³•è¿›è¡Œä¸Šé”ï¼Œé€šè¿‡unlock()é‡Šæ”¾é”</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestLock</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ticket</span> ticket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ticket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span> <span class="token string">&quot;1å·çª—å£&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span> <span class="token string">&quot;2å·çª—å£&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span> <span class="token string">&quot;3å·çª—å£&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Ticket</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> tick <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tick <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;å®Œæˆå”®ç¥¨ï¼Œä½™ç¥¨ä¸ºï¼š&quot;</span> <span class="token operator">+</span> <span class="token operator">--</span>tick<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¡ˆä¾‹</p> <p>åˆ©ç”¨this.wait()å’Œthis.this.notifyAll();å®ç°ç­‰å¾…åŠé€šçŸ¥æœºåˆ¶</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestProductorAndConsumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Productor</span> productor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Productor</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Consumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>productor<span class="token punctuation">,</span> <span class="token string">&quot;ç”Ÿäº§è€…A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>consumer<span class="token punctuation">,</span> <span class="token string">&quot;æ¶ˆè´¹è€…B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>productor<span class="token punctuation">,</span> <span class="token string">&quot;ç”Ÿäº§è€…C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>consumer<span class="token punctuation">,</span> <span class="token string">&quot;æ¶ˆè´¹è€…D&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Shop</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> product <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿›è´§</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸ºäº†é¿å…è™šå‡å”¤é†’é—®é¢˜ï¼Œåº”è¯¥æ€»æ˜¯ä½¿ç”¨å¾ªç¯æœºåˆ¶</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>product <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å•†å“å·²æ»¡ï¼æ— æ³•ç»§ç»­æ·»åŠ &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ç­‰å¾…å”¤é†’æœºåˆ¶</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token operator">++</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// é€šçŸ¥å¯ä»¥å–è´§</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token comment">// å‡ºè´§</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>product <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç¼ºè´§ï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ç­‰å¾…</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token operator">--</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// é€šçŸ¥å¯ä»¥ç»§ç»­ç”Ÿäº§</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//ç”Ÿäº§è€…</span>
<span class="token keyword">class</span> <span class="token class-name">Productor</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Shop</span> shop<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Productor</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shop <span class="token operator">=</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            shop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ¶ˆè´¹è€…</span>
<span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Shop</span> shop<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shop <span class="token operator">=</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            shop<span class="token punctuation">.</span><span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="å…«ã€condition-æ§åˆ¶çº¿ç¨‹é€šä¿¡"><a href="#å…«ã€condition-æ§åˆ¶çº¿ç¨‹é€šä¿¡" class="header-anchor">#</a> å…«ã€Condition æ§åˆ¶çº¿ç¨‹é€šä¿¡</h2> <p>Conditionæ¥å£æè¿°äº†ä¸é”æœ‰å…³çš„æ¡ä»¶å˜é‡ï¼Œä¸Object.waitè®¿é—®çš„éšå¼ç›‘è§†å™¨ç±»ä¼¼ã€‚</p> <p>åœ¨Conditionå¯¹è±¡ä¸­ï¼Œä¸waitã€notifyå’ŒnotifyAllæ–¹æ³•å¯¹åº”çš„æ˜¯awaitã€signalå’ŒsignalAllã€‚ï¼ˆç­‰å¾…é‡Šæ”¾ï¼‰</p> <p>åˆ©ç”¨Lockå’ŒConditionå®ç°ç­‰å¾…é€šçŸ¥æœºåˆ¶</p> <p>çº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´ lock.lock(); å’Œ lock.unlock();</p> <p>çº¿ç¨‹å†…éƒ¨å®ç°ç­‰å¾…condition.await(); å’Œ condition.signalAll();</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestProductorAndConsumerForLock</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Productor</span> productor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Productor</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Consumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>productor<span class="token punctuation">,</span> <span class="token string">&quot;ç”Ÿäº§è€…A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>consumer<span class="token punctuation">,</span> <span class="token string">&quot;æ¶ˆè´¹è€…B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>productor<span class="token punctuation">,</span> <span class="token string">&quot;ç”Ÿäº§è€…C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>consumer<span class="token punctuation">,</span> <span class="token string">&quot;æ¶ˆè´¹è€…D&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ShopForLock</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> product <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Condition</span> condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è¿›è´§</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä¸ºäº†é¿å…è™šå‡å”¤é†’é—®é¢˜ï¼Œåº”è¯¥æ€»æ˜¯ä½¿ç”¨å¾ªç¯æœºåˆ¶</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>product <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å•†å“å·²æ»¡ï¼æ— æ³•ç»§ç»­æ·»åŠ &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ç­‰å¾…å”¤é†’æœºåˆ¶</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token operator">++</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// é€šçŸ¥å¯ä»¥å–è´§</span>
            condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å‡ºè´§</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>product <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç¼ºè´§ï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ç­‰å¾…</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token operator">--</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// é€šçŸ¥å¯ä»¥ç»§ç»­ç”Ÿäº§</span>
            condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//ç”Ÿäº§è€…</span>
<span class="token keyword">class</span> <span class="token class-name">ProductorForLock</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Shop</span> shop<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ProductorForLock</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shop <span class="token operator">=</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            shop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ¶ˆè´¹è€…</span>
<span class="token keyword">class</span> <span class="token class-name">ConsumerForLock</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Shop</span> shop<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ConsumerForLock</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shop <span class="token operator">=</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            shop<span class="token punctuation">.</span><span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ä¹ã€çº¿ç¨‹å…«é”"><a href="#ä¹ã€çº¿ç¨‹å…«é”" class="header-anchor">#</a> ä¹ã€çº¿ç¨‹å…«é”</h2> <ul><li>ä¸¤ä¸ªæ™®é€šåŒæ­¥(åŠ é”)æ–¹æ³•ï¼Œä¸¤ä¸ªçº¿ç¨‹ï¼Œæ‰“å°ï¼Ÿ One Two</li></ul> <ul><li>æ·»åŠ æ–°å¢getOne Thread.sleep()ï¼Œæ‰“å°ï¼Ÿ One Two</li> <li>æ–°å¢æ™®é€šæ–¹æ³• getThree()ï¼Œæ‰“å°ï¼Ÿ Three One Two</li> <li>ä¸¤ä¸ªæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œä¸¤ä¸ªNumberå¯¹è±¡ï¼Œä¸¤ä¸ªçº¿ç¨‹ï¼Œæ‰“å°ï¼Ÿ Two One</li> <li>ä¿®æ”¹getOneä¸ºé™æ€åŒæ­¥æ–¹æ³•ï¼Œæ‰“å°ï¼Ÿ Two One</li> <li>ä¸¤ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œä¸€ä¸ªå¯¹è±¡ï¼Œæ‰“å°ï¼Ÿ One Two</li> <li>ä¸€ä¸ªé™æ€ä¸€ä¸ªéé™æ€ï¼Œä¸¤ä¸ªå¯¹è±¡ï¼Œæ‰“å°ï¼Ÿ Two One</li> <li>ä¸¤ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œä¸¤ä¸ªå¯¹è±¡ï¼Œæ‰“å°ï¼Ÿ One Two</li></ul> <p>å…³é”®ç‚¹ï¼š</p> <p>1ã€éé™æ€æ–¹æ³•çš„é”é»˜è®¤ä¸º thisï¼Œé™æ€æ–¹æ³•çš„é”ä¸ºå¯¹åº”çš„Classå®ä¾‹ã€‚</p> <p>2ã€æŸä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œæ— è®ºå‡ ä¸ªæ–¹æ³•ã€‚</p> <p>ä¸‹é¢æ˜¯å¯¹çº¿ç¨‹å…«é”ç®€å•å®ç°çš„ä¾‹å­ï¼Œä¾¿äºç†è§£ï¼Œä¸»è¦ç†è§£é™æ€æ–¹æ³•ã€å¯¹è±¡ã€åŒæ­¥ä¸å¦ç­‰å†…å®¹ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread8Monitor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread8MonitorDemo</span> thread8MonitorDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread8MonitorDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread8MonitorDemo</span> thread8MonitorDemo1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread8MonitorDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                thread8MonitorDemo<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;One&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//                thread8MonitorDemo.getTwo();</span>
                thread8MonitorDemo1<span class="token punctuation">.</span><span class="token function">getTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Two&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        new Thread(new Runnable() {</span>
<span class="token comment">//            @Override</span>
<span class="token comment">//            public void run() {</span>
<span class="token comment">//                thread8MonitorDemo.getThree();</span>
<span class="token comment">//            }</span>
<span class="token comment">//        }, &quot;Three&quot;).start();</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Thread8MonitorDemo</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;One&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">getTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;Two&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getThree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;Three&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="åã€çº¿ç¨‹æŒ‰åºäº¤æ›¿"><a href="#åã€çº¿ç¨‹æŒ‰åºäº¤æ›¿" class="header-anchor">#</a> åã€çº¿ç¨‹æŒ‰åºäº¤æ›¿</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestAGCAlternate</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ALternate</span> aLternate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ALternate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    aLternate<span class="token punctuation">.</span><span class="token function">loadA</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    aLternate<span class="token punctuation">.</span><span class="token function">loadB</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    aLternate<span class="token punctuation">.</span><span class="token function">loadC</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ALternate</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Condition</span> condition1 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Condition</span> condition2 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Condition</span> condition3 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadA</span><span class="token punctuation">(</span><span class="token keyword">int</span> totalLoop<span class="token punctuation">)</span><span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœnumberä¸æ˜¯ä¸º1ï¼Œé‚£ä¹ˆcondition1åˆ™ä¸€ç›´ç­‰å¾…ï¼Œç›´è‡³numberä¸º1</span>
                condition1<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> totalLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            number <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token comment">// é€šçŸ¥condition2å¯ä»¥å¼€å§‹è¿è¡Œ</span>
            condition2<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadB</span><span class="token punctuation">(</span><span class="token keyword">int</span> totalLoop<span class="token punctuation">)</span><span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                condition2<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> totalLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            number <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
            condition3<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadC</span><span class="token punctuation">(</span><span class="token keyword">int</span> totalLoop<span class="token punctuation">)</span><span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                condition3<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> totalLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            condition1<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="åä¸€ã€readwritelock-è¯»å†™é”"><a href="#åä¸€ã€readwritelock-è¯»å†™é”" class="header-anchor">#</a> åä¸€ã€ReadWritelock è¯»å†™é”</h2> <p>å†™å†™ã€è¯»å†™ï¼Œéœ€è¦äº’æ–¥</p> <p>è¯»è¯»ï¼Œä¸éœ€è¦äº’æ–¥</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestReadAndWriteLock</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReadAndWriteDemo</span> readAndWriteDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadAndWriteDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                readAndWriteDemo<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;å†™é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    readAndWriteDemo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;è¯»é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ReadAndWriteDemo</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ReadWriteLock</span> readWriteLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è¯»</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// ä¸Šé”</span>
        readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å†™</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">)</span><span class="token punctuation">{</span>
        readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>number <span class="token operator">=</span> number<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="åäºŒã€çº¿ç¨‹æ± "><a href="#åäºŒã€çº¿ç¨‹æ± " class="header-anchor">#</a> åäºŒã€çº¿ç¨‹æ± </h2> <p>çº¿ç¨‹æ± ï¼šæä¾›äº†ä¸€ä¸ªçº¿ç¨‹é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­ä¿å­˜ç€æ‰€æœ‰ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ï¼Œé¿å…äº†åˆ›å»ºä¸é”€æ¯çº¿ç¨‹çš„å¼€é”€ï¼Œæé«˜äº†å“åº”çš„é€Ÿåº¦</p> <p>çº¿ç¨‹æ± çš„ä½“ç³»ç»“æ„ï¼š</p> <ul><li>ExecutorService å­æ¥å£ï¼šçº¿ç¨‹æ± çš„ä¸»è¦æ¥å£
<ul><li>ThreadPoolExecutor çº¿ç¨‹æ± çš„ä¸»è¦å®ç°ç±»</li> <li>ScheduleExecutorServiceï¼šå­æ¥å£ï¼šè´Ÿè´£çº¿ç¨‹çš„è°ƒåº¦
<ul><li>ScheduleThreadPoolExecutorï¼šç»§æ‰¿ ThreadPoolExecutor å®ç° ScheduleExecutorService</li></ul></li></ul></li></ul> <p>å·¥å…·ç±»Executors</p> <ul><li>Executors.newFixedThreadPool()ï¼šåˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± </li> <li>Executors.newCachedThreadPool()ï¼šç¼“å­˜çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± çš„æ•°é‡ä¸å›ºå®šï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è‡ªåŠ¨çš„æ›´æ”¹æ•°é‡</li> <li>Executors.newSingleThreadExecutor()ï¼šåˆ›å»ºå•ä¸ªçº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹</li> <li>Executors.newScheduledThreadPool()ï¼šåˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹ï¼Œå¯ä»¥å»¶æ—¶æˆ–å®šæ—¶çš„æ‰§è¡Œä»»åŠ¡</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestThreadPool</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolDemo</span> threadPoolDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºçº¿ç¨‹æ± </span>
        <span class="token class-name">ExecutorService</span> pool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹åˆ†é…ä»»åŠ¡</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>threadPoolDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å…³é—­çº¿ç¨‹æ± </span>
        pool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ThreadPoolDemo</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="åä¸‰ã€çº¿ç¨‹è°ƒåº¦"><a href="#åä¸‰ã€çº¿ç¨‹è°ƒåº¦" class="header-anchor">#</a> åä¸‰ã€çº¿ç¨‹è°ƒåº¦</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestScheduledPool</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ScheduledExecutorService</span> pool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> schedule <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="åå››ã€forkjoinpool-åˆ†æ”¯-åˆå¹¶æ¡†æ¶-å·¥ä½œçªƒå–"><a href="#åå››ã€forkjoinpool-åˆ†æ”¯-åˆå¹¶æ¡†æ¶-å·¥ä½œçªƒå–" class="header-anchor">#</a> åå››ã€ForkJoinPool åˆ†æ”¯/åˆå¹¶æ¡†æ¶ å·¥ä½œçªƒå–</h2> <p>ä½¿ç”¨ForkJoinPoolè¿›è¡Œæ‹†åˆ†æ“ä½œ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestForkJoinPool</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ForkJoinPool</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPoolDemo</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> <span class="token number">100000000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> sum <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ForkJoinPoolDemo</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> start<span class="token punctuation">,</span> end<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">THURSHOLD</span> <span class="token operator">=</span> <span class="token number">10000L</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">ForkJoinPoolDemo</span><span class="token punctuation">(</span><span class="token keyword">long</span> start<span class="token punctuation">,</span> <span class="token keyword">long</span> end<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Long</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> length <span class="token operator">=</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> <span class="token constant">THURSHOLD</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">long</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                sum <span class="token operator">+=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> middle <span class="token operator">=</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> end<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token class-name">ForkJoinPoolDemo</span> left <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPoolDemo</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> middle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            left<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è¿›è¡Œæ‹†åˆ†ï¼ŒåŒæ—¶å‹å…¥çº¿ç¨‹é˜Ÿåˆ—</span>
            <span class="token class-name">ForkJoinPoolDemo</span> right <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPoolDemo</span><span class="token punctuation">(</span>middle<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
            right<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è¿›è¡Œæ‹†åˆ†ï¼ŒåŒæ—¶å‹å…¥çº¿ç¨‹é˜Ÿåˆ—</span>
            <span class="token keyword">return</span> left<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>right<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="å¹¶å‘å·¥å…·ç±»"><a href="#å¹¶å‘å·¥å…·ç±»" class="header-anchor">#</a> å¹¶å‘å·¥å…·ç±»</h2> <p>CountDownLatch</p> <p>CyclicBarrier</p> <p>Semaphore</p> <p>Exchanger</p> <h3 id="countdownlatch-ç­‰å¾…å¤šçº¿ç¨‹å®Œæˆ"><a href="#countdownlatch-ç­‰å¾…å¤šçº¿ç¨‹å®Œæˆ" class="header-anchor">#</a> CountDownLatch ç­‰å¾…å¤šçº¿ç¨‹å®Œæˆ</h3> <p>CountDownLatchå…è®¸ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆæ“ä½œ</p> <p>joinæ“ä½œå¯ä»¥è®©å½“å‰æ‰§è¡Œçº¿ç¨‹ç­‰å¾…joinçº¿ç¨‹æ‰§è¡Œç»“æŸã€‚å…¶å®ç°åŸç†æ˜¯ä¸åœçš„æ£€æŸ¥joinçº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœjoinçº¿ç¨‹å­˜è´§åˆ™è®©å½“å‰çº¿ç¨‹æ°¸è¿œç­‰å¾…ã€‚å…¶ä¸­ wait(0)è¡¨ç¤ºæ°¸è¿œç­‰å¾…ä¸‹å»</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">BXuan</span><span class="token punctuation">.</span>test<span class="token punctuation">.</span>concurrentTest<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatchTest01</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread01 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread02 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;çº¿ç¨‹2å·²å®Œæˆ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        thread01<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread02<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread01<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread02<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ‰€æœ‰çº¿ç¨‹å·¥ä½œå®Œæˆ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“joinçº¿ç¨‹ç»ˆæ­¢åï¼Œçº¿ç¨‹çš„this.notifyAll()æ–¹æ³•æ‰ä¼šè¢«è°ƒç”¨ï¼Œè°ƒç”¨notifyAll()æ–¹æ³•æ˜¯åœ¨JVMé‡Œé¢å®ç°çš„ï¼Œæ‰€ä»¥åœ¨JDKåŒ…é‡Œé¢çœ‹ä¸åˆ°ã€‚</p> <p>JDK 1.5ä¹‹åçš„CountDownLatchä¹Ÿå¯ä»¥æ˜¯å®ç°joinçš„åŠŸèƒ½ï¼Œå¹¶ä¸”æ¯”joinçš„åŠŸèƒ½æ›´å¤š</p> <p>CountDownLatchçš„await()æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æ–¹æ³•ä¸­çš„è®¡æ•°å™¨countå˜æˆ0</p> <p>CountDownLatchå¯ä»¥ç”¨åœ¨ä»»ä½•åœ°æ–¹ï¼Œæ‰€ä»¥è¿™é‡Œçš„countå¯ä»¥æ˜¯countä¸ªçº¿ç¨‹ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªçº¿ç¨‹é‡Œé¢çš„countä¸ªæ­¥éª¤ã€‚ç”¨åœ¨å¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œåªéœ€è¦æŠŠCountDownLatché‡Œé¢çš„å¼•ç”¨ä¼ é€’åˆ°è¿™ä¸ªå¤šçº¿ç¨‹é‡Œé¢å³å¯ã€‚</p> <p>å¦‚æœæŸä¸ªçº¿ç¨‹æ‰§è¡Œæ¯”è¾ƒæ…¢çš„è¯ï¼Œæˆ‘ä»¬ä¸å¯èƒ½è®©ä¸»çº¿ç¨‹ä¸€ç›´å¤„äºç­‰å¾…çš„çŠ¶æ€ï¼Œé‚£ä¹ˆæ­¤æ—¶å¯ä»¥ä½¿ç”¨CountDownLatché‡Œé¢çš„await(long timeout, TimeUnit unit)æ–¹æ³•æ¥è®¾å®šæ—¶é—´ã€‚</p> <p>è®¡æ•°å™¨countå¿…é¡»å¤§äº0ï¼Œå½“count == 0çš„æ—¶å€™ï¼Œawaitæ–¹æ³•ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">BXuan</span><span class="token punctuation">.</span>test<span class="token punctuation">.</span>concurrentTest<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatchTest02</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// awaitä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´è‡³countDownLatchæ‰§è¡Œå®Œæˆ</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="cyclicbarrier-åŒæ­¥å±éšœ"><a href="#cyclicbarrier-åŒæ­¥å±éšœ" class="header-anchor">#</a> CyclicBarrier åŒæ­¥å±éšœ</h3> <p>CyclicBarrierçš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ï¼ˆCyclicï¼‰ä½¿ç”¨çš„å±éšœï¼ˆBarrierï¼‰ï¼Œå®ƒæ‰€åšçš„äº‹æƒ…ï¼Œå°±æ˜¯è®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœæ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹å¾—ä»¥è¿è¡Œã€‚</p> <p>CyclicBarrierè¿˜æœ‰ä¸€ä¸ªæ›´é«˜çº§çš„æ„é€ å‡½æ•°ï¼Œå°±æ˜¯å¯ä»¥ç”¨åœ¨çº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œä¼˜å…ˆæ‰§è¡ŒbarrierActionï¼Œæ–¹ä¾¿å¤„ç†æ›´å¤æ‚çš„ä¸šåŠ¡</p> <ul><li>CyclicBarrieråº”ç”¨åœºæ™¯</li></ul> <p>å¯ä»¥ç”¨äºå¤šçº¿ç¨‹è®¡ç®—æ•°æ®ï¼Œå¦‚é“¶è¡Œè®¡ç®—</p> <ul><li>CyclicBarrierä¸CountDownLatchçš„åŒºåˆ«</li></ul> <p>1ã€CountDownLatchçš„è®¡æ•°å™¨åªèƒ½è¿è¡Œä¸€æ¬¡ï¼Œè€ŒCyclicBarrierå¯ä»¥è¿ç”¨reset()æ–¹æ³•é‡æ–°åˆå§‹åŒ–è®¡æ•°å™¨ã€‚</p> <p>2ã€CyclicBarrierçš„ä¸€äº›å…¶ä»–ç”¨æ³•æ›´é«˜çº§ï¼Œè¯¦ç»†è¯·æŸ¥çœ‹æºç ã€‚</p> <h3 id="semaphore-æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°"><a href="#semaphore-æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°" class="header-anchor">#</a> Semaphore æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°</h3> <p>Semaphoreï¼ˆä¿¡å·é‡ï¼‰æ˜¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹çš„æ•°é‡ï¼Œé€šè¿‡åè°ƒå„ä¸ªçº¿ç¨‹ï¼Œä»¥ä¿è¯åˆç†çš„ä½¿ç”¨å…¬å…±èµ„æºã€‚</p> <ul><li>åº”ç”¨åœºæ™¯</li></ul> <p>æµé‡æ§åˆ¶</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">BXuan</span><span class="token punctuation">.</span>test<span class="token punctuation">.</span>concurrentTest<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Semaphore</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SemaphoreTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">THREAD_COUNT</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Semaphore</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        s<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;save date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        s<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ä»£ç ä¸­ï¼Œè™½ç„¶æœ‰30ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œä½†æ˜¯ç»è¿‡Semaphoreçš„çº¦æŸï¼ŒçœŸæ­£è¿›è¡Œå¹¶å‘çš„åªæœ‰10ä¸ªè¿›ç¨‹ã€‚</p> <p>Semaphoreçš„æ„é€ æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæ¥æ”¶ä¸€ä¸ªæ•´å‹çš„æ•°å­—ï¼Œè¡¨ç¤ºå†…éƒ¨çš„è®¸å¯è¯çš„æ•°é‡ã€‚</p> <p>s.acquire(); è¡¨ç¤ºè·å¾—ä¸€å¼ è®¸å¯è¯
s.release(); è¡¨ç¤ºå½’è¿˜è®¸å¯è¯</p> <h3 id="çº¿ç¨‹é—´äº¤æ¢æ•°æ®-exchanger"><a href="#çº¿ç¨‹é—´äº¤æ¢æ•°æ®-exchanger" class="header-anchor">#</a> çº¿ç¨‹é—´äº¤æ¢æ•°æ® Exchanger</h3> <p>Exchangeræ˜¯ä¸€ä¸ªç”¨äºçº¿ç¨‹é—´åä½œçš„å·¥å…·ç±»ï¼ŒExchangerç”¨äºè¿›è¡Œçº¿ç¨‹é—´çš„æ•°æ®äº¤æ¢</p> <p>æä¾›ä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œåœ¨è¿™ä¸ªåŒæ­¥ç‚¹ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯ä»¥å½¼æ­¤äº¤æ¢æ•°æ®</p> <ul><li>åº”ç”¨åœºæ™¯</li></ul> <p>é—ä¼ ç®—æ³•</p> <p>æ ¡å¯¹å·¥ä½œ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">BXuan</span><span class="token punctuation">.</span>test<span class="token punctuation">.</span>concurrentTest<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Exchanger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExchangerTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exchanger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> pool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> <span class="token class-name">A</span> <span class="token operator">=</span> <span class="token string">&quot;é“¶è¡Œæµæ°´A&quot;</span><span class="token punctuation">;</span>
                    exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> <span class="token class-name">B</span> <span class="token operator">=</span> <span class="token string">&quot;é“¶è¡Œæµæ°´B&quot;</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> <span class="token class-name">A</span> <span class="token operator">=</span> exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸¤ä¸ªçº¿ç¨‹ä¸­å¦‚æœæœ‰ä¸€ä¸ªæ²¡æœ‰æ‰§è¡Œexchangeæ–¹æ³•ï¼Œåˆ™ä¼šä¸€ç›´ç­‰å¾…ã€‚</p> <p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°æ¥è®¾ç½®æœ€å¤§ç­‰å¾…çš„æ—¶é—´</p> <h2 id="javaå¹¶å‘çš„åº•å±‚å®ç°æœºåˆ¶"><a href="#javaå¹¶å‘çš„åº•å±‚å®ç°æœºåˆ¶" class="header-anchor">#</a> Javaå¹¶å‘çš„åº•å±‚å®ç°æœºåˆ¶</h2> <p>Java ä»£ç åœ¨ç¼–è¯‘åå˜æˆ Java å­—èŠ‚ç ï¼Œå­—èŠ‚ç è¢«ç±»åŠ è½½å™¨åŠ è½½åˆ° JVMï¼ŒJVMæ‰§è¡Œå­—èŠ‚ç ï¼Œæœ€ç»ˆè½¬æ¢æˆæ±‡ç¼–æŒ‡ä»¤åœ¨ CPU ä¸Šæ‰§è¡Œã€‚</p> <h3 id="volatile-çš„åº”ç”¨"><a href="#volatile-çš„åº”ç”¨" class="header-anchor">#</a> Volatile çš„åº”ç”¨</h3> <p>volatile æ—¶è½»é‡çº§çš„ synchronizedï¼Œåœ¨å¤šå¤„ç†å™¨å¼€å‘ä¸­ä¿è¯äº†å…±äº«å˜é‡çš„ â€œå¯è§æ€§â€ã€‚å¯è§æ€§çš„æ„æ€æ˜¯å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ä¸€ä¸ªå…±äº«å˜é‡æ—¶ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹èƒ½è¯»åˆ°è¿™ä¸ªå˜é‡çš„ä¿®æ”¹æƒ…å†µã€‚</p> <p>å¦‚æœä¸€ä¸ªå­—æ®µè¢«å£°æ˜ä¸º volatileï¼ŒJava çº¿ç¨‹å†…å­˜æ¨¡å‹ç¡®ä¿æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°è¿™ä¸ªå˜é‡çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚</p> <h3 id="synchronized-çš„å®ç°åŸç†ä¸åº”ç”¨"><a href="#synchronized-çš„å®ç°åŸç†ä¸åº”ç”¨" class="header-anchor">#</a> synchronized çš„å®ç°åŸç†ä¸åº”ç”¨</h3> <p><code>synchronized</code>å…³é”®å­—æ˜¯Javaå¹¶å‘ç¼–ç¨‹ä¸­çº¿ç¨‹åŒæ­¥çš„å¸¸ç”¨æ‰‹æ®µä¹‹ä¸€ï¼Œå…¶ä½œç”¨æœ‰ä¸‰ä¸ª:</p> <blockquote><ol><li>äº’æ–¥æ€§ï¼šç¡®ä¿çº¿ç¨‹äº’æ–¥çš„è®¿é—®åŒæ­¥ä»£ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼Œå¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸ªä»£ç å—æˆ–å‡½æ•°å¿…é¡»æ’é˜Ÿè·å¾—é”ï¼Œ</li> <li>å¯è§æ€§ï¼šä¿è¯å…±äº«å˜é‡çš„ä¿®æ”¹èƒ½å¤ŸåŠæ—¶å¯è§ï¼Œè·å¾—é”çš„çº¿ç¨‹æ“ä½œå®Œæ¯•åä¼šå°†æ‰€æ•°æ®åˆ·æ–°åˆ°å…±äº«å†…å­˜åŒº[1]</li> <li>æœ‰åºæ€§ï¼šä¸è§£å†³é‡æ’åºï¼Œä½†ä¿è¯æœ‰åºæ€§</li></ol></blockquote> <p><code>synchronized</code>ç”¨æ³•æœ‰ä¸‰ä¸ª:</p> <blockquote><ol><li>ä¿®é¥°å®ä¾‹æ–¹æ³•</li> <li>ä¿®é¥°é™æ€æ–¹æ³•</li> <li>ä¿®é¥°ä»£ç å—</li></ol></blockquote> <h4 id="_1-ä¿®é¥°å®ä¾‹æ–¹æ³•"><a href="#_1-ä¿®é¥°å®ä¾‹æ–¹æ³•" class="header-anchor">#</a> 1. ä¿®é¥°å®ä¾‹æ–¹æ³•</h4> <p><code>synchronized</code>å…³é”®è¯ä½œç”¨åœ¨æ–¹æ³•çš„å‰é¢ï¼Œç”¨æ¥é”å®šæ–¹æ³•ï¼Œå…¶å®é»˜è®¤é”å®šçš„æ˜¯<code>this</code>å¯¹è±¡ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread1</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
    <span class="token comment">//å…±äº«èµ„æº(ä¸´ç•Œèµ„æº)</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//å¦‚æœæ²¡æœ‰synchronizedå…³é”®å­—ï¼Œè¾“å‡ºå°äº20000</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread1</span> t<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸»çº¿ç¨‹ç­‰å¾…t1æ‰§è¡Œå®Œæ¯•</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸»çº¿ç¨‹ç­‰å¾…t2æ‰§è¡Œå®Œæ¯•</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>20000</p> <h4 id="_2-ä¿®é¥°é™æ€æ–¹æ³•"><a href="#_2-ä¿®é¥°é™æ€æ–¹æ³•" class="header-anchor">#</a> 2. ä¿®é¥°é™æ€æ–¹æ³•</h4> <p><code>synchronized</code>è¿˜æ˜¯ä¿®é¥°åœ¨æ–¹æ³•ä¸Šï¼Œä¸è¿‡ä¿®é¥°çš„æ˜¯é™æ€æ–¹æ³•ï¼Œç­‰ä»·äºé”å®šçš„æ˜¯<code>Class</code>å¯¹è±¡ï¼Œ</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread1</span> <span class="token punctuation">{</span>
    <span class="token comment">//å…±äº«èµ„æº(ä¸´ç•Œèµ„æº)</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//å¦‚æœæ²¡æœ‰synchronizedå…³é”®å­—ï¼Œè¾“å‡ºå°äº20000</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸»çº¿ç¨‹ç­‰å¾…t1æ‰§è¡Œå®Œæ¯•</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸»çº¿ç¨‹ç­‰å¾…t2æ‰§è¡Œå®Œæ¯•</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-ä¿®é¥°ä»£ç å—"><a href="#_3-ä¿®é¥°ä»£ç å—" class="header-anchor">#</a> 3. ä¿®é¥°ä»£ç å—</h4> <p>ç”¨æ³•æ˜¯åœ¨å‡½æ•°ä½“å†…éƒ¨å¯¹äºè¦ä¿®æ”¹çš„å‚æ•°åŒºé—´ç”¨<code>synchronized</code>æ¥ä¿®é¥°ï¼Œç›¸æ¯”ä¸é”å®šå‡½æ•°è¿™ä¸ªèŒƒå›´æ›´å°ï¼Œå¯ä»¥æŒ‡å®šé”å®šä»€ä¹ˆå¯¹è±¡ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread1</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token comment">//å…±äº«èµ„æº(ä¸´ç•Œèµ„æº)</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//è·å¾—äº†Stringçš„ç±»é”</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread1</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ€»ç»“ï¼š</p> <blockquote><ol><li>synchronizedä¿®é¥°çš„å®ä¾‹æ–¹æ³•ï¼Œå¤šçº¿ç¨‹å¹¶å‘è®¿é—®æ—¶ï¼Œ<code>åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥</code>ï¼Œè·å¾—å¯¹è±¡å†…ç½®é”ï¼Œå…¶ä»–çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œä½†åœ¨æ­¤æœŸé—´çº¿ç¨‹ä»ç„¶å¯ä»¥è®¿é—®å…¶ä»–æ–¹æ³•ã€‚</li> <li>synchronizedä¿®é¥°çš„é™æ€æ–¹æ³•ï¼Œå¤šçº¿ç¨‹å¹¶å‘è®¿é—®æ—¶ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œè·å¾—ç±»é”ï¼Œå…¶ä»–çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œä½†åœ¨æ­¤æœŸé—´çº¿ç¨‹ä»ç„¶å¯ä»¥è®¿é—®å…¶ä»–æ–¹æ³•ã€‚</li> <li>synchronizedä¿®é¥°çš„ä»£ç å—ï¼Œå¤šçº¿ç¨‹å¹¶å‘è®¿é—®æ—¶ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œæ ¹æ®æ‹¬å·ä¸­çš„å¯¹è±¡æˆ–è€…æ˜¯ç±»ï¼Œè·å¾—ç›¸åº”çš„å¯¹è±¡å†…ç½®é”æˆ–è€…æ˜¯ç±»é”</li> <li>æ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªç±»é”ï¼Œç±»çš„æ¯ä¸ªå¯¹è±¡ä¹Ÿæœ‰ä¸€ä¸ªå†…ç½®é”ï¼Œå®ƒä»¬æ˜¯<code>äº’ä¸å¹²æ‰°</code>çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è·å¾—ç±»é”å’Œè¯¥ç±»å®ä¾‹åŒ–å¯¹è±¡çš„å†…ç½®é”ï¼Œå½“çº¿ç¨‹è®¿é—®ésynchronziedä¿®é¥°çš„æ–¹æ³•æ—¶ï¼Œå¹¶ä¸éœ€è¦è·å¾—é”ï¼Œå› æ­¤ä¸ä¼šäº§ç”Ÿé˜»å¡ã€‚</li></ol></blockquote> <h3 id="ç®¡ç¨‹"><a href="#ç®¡ç¨‹" class="header-anchor">#</a> ç®¡ç¨‹</h3> <p>ç®¡ç¨‹ (è‹±è¯­ï¼šMonitorsï¼Œä¹Ÿç§°ä¸ºç›‘è§†å™¨) åœ¨æ“ä½œç³»ç»Ÿä¸­æ˜¯å¾ˆé‡è¦çš„æ¦‚å¿µï¼Œç®¡ç¨‹å…¶å®æŒ‡çš„æ˜¯<code>ç®¡ç†å…±äº«å˜é‡ä»¥åŠç®¡ç†å…±äº«å˜é‡çš„æ“ä½œè¿‡ç¨‹</code>ã€‚æœ‰ç‚¹æ‰®æ¼”ä¸­ä»‹çš„æ„æ€ï¼Œç®¡ç¨‹ç®¡ç†ä¸€å †å¯¹è±¡ï¼Œå¤šä¸ªçº¿ç¨‹åŒä¸€æ—¶å€™åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ¥è®¿é—®è¿™äº›ä¸œè¥¿ã€‚</p> <ol><li>ç®¡ç¨‹å¯ä»¥çœ‹åšä¸€ä¸ªè½¯ä»¶æ¨¡å—ï¼Œå®ƒæ˜¯å°†å…±äº«çš„å˜é‡å’Œå¯¹äºè¿™äº›å…±äº«å˜é‡çš„æ“ä½œå°è£…èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªå…·æœ‰ä¸€å®šæ¥å£çš„åŠŸèƒ½æ¨¡å—ï¼Œè¿›ç¨‹å¯ä»¥è°ƒç”¨<code>ç®¡ç¨‹</code>æ¥å®ç°è¿›ç¨‹çº§åˆ«çš„å¹¶å‘æ§åˆ¶ã€‚</li> <li>è¿›ç¨‹åªèƒ½äº’æ–¥çš„ä½¿ç”¨ç®¡ç¨‹ï¼Œå³å½“ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ç®¡ç¨‹æ—¶ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹å¿…é¡»ç­‰å¾…ã€‚å½“ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨å®Œç®¡ç¨‹åï¼Œå®ƒå¿…é¡»é‡Šæ”¾ç®¡ç¨‹å¹¶å”¤é†’ç­‰å¾…ç®¡ç¨‹çš„æŸä¸€ä¸ªè¿›ç¨‹ã€‚</li></ol> <p>ç®¡ç¨‹è§£å†³äº’æ–¥é—®é¢˜ç›¸å¯¹ç®€å•ï¼ŒæŠŠå…±äº«å˜é‡ä»¥åŠå…±äº«å˜é‡çš„æ“ä½œéƒ½å°è£…åœ¨ä¸€ä¸ªç±»ä¸­</p> <p>å½“çº¿ç¨‹Aå’Œçº¿ç¨‹Béœ€è¦è·å–å…±äº«å˜é‡countæ—¶ï¼Œå°±éœ€è¦è°ƒç”¨getå’Œsetæ–¹æ³•ï¼Œè€Œgetå’Œsetæ–¹æ³•åˆ™ä¿è¯äº’æ–¥æ€§ï¼Œä¿è¯æ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚</p> <p>ç”Ÿæ´»ä¸­ä¸¾ä¾‹ç®¡ç¨‹æ¯”å¦‚é“¾å®¶åº—é•¿åˆ†é…ç»™æ¯ä¸€ä¸ªä¸­ä»‹ç®¡ç†ä¸€éƒ¨åˆ†äºŒæ‰‹æˆ¿æºï¼Œå¤šä¸ªå®¢æˆ·é€šè¿‡ä¸­ä»‹è¿›è¡Œæˆ¿å±‹ä¹°å–ã€‚</p> <ol><li>ä¸­ä»‹ å°±æ˜¯ç®¡ç¨‹ã€‚</li> <li>å¤šä¸ªäºŒæ‰‹æˆ¿æºè¢«ä¸€ä¸ªä¸­ä»‹ç®¡ç†ä¸­ï¼Œå°±æ˜¯ä¸€ä¸ªç®¡ç¨‹ç®¡ç†ç€å¤šä¸ªç³»ç»Ÿèµ„æºã€‚</li> <li>å¤šä¸ªå®¢æˆ·å°±ç›¸å½“äºå¤šä¸ªçº¿ç¨‹ã€‚</li></ol> <h3 id="synchronziedçš„åº•å±‚åŸç†"><a href="#synchronziedçš„åº•å±‚åŸç†" class="header-anchor">#</a> Synchronziedçš„åº•å±‚åŸç†</h3> <p>æˆ‘ä»¬çŸ¥é“åœ¨Javaçš„JVMå†…å­˜åŒºåŸŸä¸­ä¸€ä¸ªå¯¹è±¡åœ¨å †åŒºåˆ›å»ºï¼Œåˆ›å»ºåçš„å¯¹è±¡ç”±ä¸‰éƒ¨åˆ†ç»„æˆã€‚</p> <p>è¿™ä¸‰éƒ¨åˆ†åŠŸèƒ½å¦‚ä¸‹ï¼š</p> <ol><li><code>å¡«å……æ•°æ®</code>ï¼šç”±äºè™šæ‹Ÿæœºè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ã€‚å¡«å……æ•°æ®ä¸æ˜¯å¿…é¡»å­˜åœ¨çš„ï¼Œä»…ä»…æ˜¯ä¸ºäº†<code>å­—èŠ‚å¯¹é½</code>ã€‚</li> <li><code>å®ä¾‹å˜é‡</code>ï¼šå­˜æ”¾ç±»çš„<code>å±æ€§æ•°æ®</code>ä¿¡æ¯ï¼ŒåŒ…æ‹¬<code>çˆ¶ç±»</code>çš„å±æ€§ä¿¡æ¯ï¼Œè¿™éƒ¨åˆ†å†…å­˜æŒ‰4å­—èŠ‚å¯¹é½ã€‚</li> <li><code>å¯¹è±¡å¤´</code>ï¼šä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ† <code>Klass Point</code>è·Ÿ <code>Mark Word</code></li></ol> <blockquote><p>1ã€Klass Point<code>(ç±»å‹æŒ‡é’ˆ)ï¼šæ˜¯å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚</code></p> <p>2ã€Mark Word<code>(æ ‡è®°å­—æ®µ)ï¼šè¿™ä¸€éƒ¨åˆ†ç”¨äºå‚¨å­˜å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚</code>å“ˆå¸Œç <code>ï¼Œ</code>GC<code>åˆ†ä»£å¹´é¾„ï¼Œ</code>é”çŠ¶æ€æ ‡å¿—<code>ï¼Œ</code>é”æŒ‡é’ˆ<code>ç­‰ï¼Œè¿™éƒ¨åˆ†æ•°æ®åœ¨32bitå’Œ64bitçš„è™šæ‹Ÿæœºä¸­å¤§å°åˆ†åˆ«ä¸º32bitå’Œ64bitï¼Œè€ƒè™‘åˆ°è™šæ‹Ÿæœºçš„ç©ºé—´æ•ˆç‡ï¼ŒMark Wordè¢«è®¾è®¡æˆä¸€ä¸ª</code>éå›ºå®š`çš„æ•°æ®ç»“æ„ä»¥ä¾¿åœ¨æå°çš„ç©ºé—´ä¸­å­˜å‚¨å°½é‡å¤šçš„ä¿¡æ¯ï¼Œå®ƒä¼šæ ¹æ®å¯¹è±¡çš„çŠ¶æ€å¤ç”¨è‡ªå·±çš„å­˜å‚¨ç©ºé—´(è·Ÿ<a href="https://mp.weixin.qq.com/s?__biz=MzI4NjI1OTI4Nw==&amp;mid=2247487563&amp;idx=1&amp;sn=0a223ae2bba963e3ac40b7ce6d9ecd56&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ConcurrentHashMap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>é‡Œçš„æ ‡å¿—ä½ç±»ä¼¼)ï¼Œè¯¦ç»†æƒ…å†µå¦‚ä¸‹å›¾ï¼š</p></blockquote> <p><code>Mark Word</code>çŠ¶æ€è¡¨ç¤ºä½å¦‚ä¸‹ï¼š</p> <p><code>synchronized</code>ä¸è®ºæ˜¯ä¿®é¥°æ–¹æ³•è¿˜æ˜¯ä»£ç å—ï¼Œéƒ½æ˜¯é€šè¿‡æŒæœ‰ä¿®é¥°å¯¹è±¡çš„<code>é”</code>æ¥å®ç°åŒæ­¥ï¼Œ<code>synchronized</code>é”å¯¹è±¡æ˜¯å­˜åœ¨å¯¹è±¡å¤´<code>Mark Word</code>ã€‚å…¶ä¸­è½»é‡çº§é”å’Œåå‘é”æ˜¯<code>Java6</code>å¯¹<code>synchronized</code>é”è¿›è¡Œä¼˜åŒ–åæ–°å¢åŠ çš„ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦åˆ†æä¸€ä¸‹é‡é‡çº§é”ä¹Ÿå°±æ˜¯é€šå¸¸è¯´synchronizedçš„å¯¹è±¡é”ï¼Œé”æ ‡è¯†ä½ä¸º10ï¼Œå…¶ä¸­æŒ‡é’ˆæŒ‡å‘çš„æ˜¯<code>monitor</code>å¯¹è±¡ï¼ˆä¹Ÿç§°ä¸ºç®¡ç¨‹æˆ–ç›‘è§†å™¨é”ï¼‰çš„èµ·å§‹åœ°å€ã€‚æ¯ä¸ªå¯¹è±¡éƒ½å­˜åœ¨ç€ä¸€ä¸ª monitor ä¸ä¹‹å…³è”ã€‚</p> <h3 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="header-anchor">#</a> ç›¸å…³é“¾æ¥</h3> <p><a href="https://mp.weixin.qq.com/s?__biz=MzI4NjI1OTI4Nw==&amp;mid=2247488320&amp;idx=1&amp;sn=6fd5cddf2a0ff68fe00ccc834e90521b&amp;scene=21&amp;key=d3ddac21ee143f5ae14d67c5c8354109b955a541f15a225358d5c1977c3d01d5a870045d177fbb9330c4239ce8cd85abd6e18ded7f9072f594fe20f7fccd6c04b40b56c419e0b5c12215e10fee3157ba585d9bb3b9f5ada851eeab1cd0885914eaa227495eed17fb27f6368c01aab04c2174064644b483c7dc1bece002b2954e&amp;ascene=7&amp;uin=MTk5NTU2ODc4&amp;devicetype=Windows+10+x64&amp;version=63080029&amp;lang=zh_CN&amp;exportkey=n_ChQIAhIQySqRRf1TyHp8K4bD6S0l9xLZAQIE97dBBAEAAAAAAKXiDT%2BXZm0AAAAOpnltbLcz9gKNyK89dVj0fjiG4FDoHTqd7B9dhBmxmsAA1UXd%2FRs23o5lqqf2LE3Dvn96iQnKS9gkwbuVcfDE5NeIbGG%2F9HXry4QnZXVoXIynlAREWYGQnvXSt4QHd6R%2F7DeN4QmllmZPihxPxBdWOEO6P0SEz6Tio8rdd0KHOqhXkDwzU6mk7L1w6Yx9hl2HEu25ONjDhO7rfBG0sm8WusaJaSn7h3OW0UcHF9qOl56jUZzS5FwbzwRYa7%2FbEv8PJiw%3D&amp;acctmode=0&amp;pass_ticket=vhkXFd%2Fd0WidwSlj%2F8wIdz%2F4lplqBac9pDoHsF7nL%2BhYFIJzWfM4DmDrg7OkODYx&amp;wx_header=1&amp;fontgear=2" target="_blank" rel="noopener noreferrer">ç”±æµ…å…¥æ·±é€æ­¥äº†è§£ Synchronized<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[1]ç®¡ç¨‹:https://www.zhihu.com/question/30641734</p> <p>[2]monitor:http://www.hollischuang.com/archives/2030</p> <p>[3]æ¯”æ–¹:https://blog.csdn.net/xyh930929/article/details/84571805</p> <p>[4]unbelievableme:https://www.cnblogs.com/kundeg/p/8422557.html</p> <p>[5]å¤´æ¡å¤§ä½¬è®²syn:https://blog.csdn.net/javazejian/article/details/72828483</p> <p>[6]é˜¿é‡Œholliså°†syn:http://www.hollischuang.com/archives/2030</p> <h2 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="header-anchor">#</a> åˆ†å¸ƒå¼é”</h2> <h3 id="åˆ†å¸ƒå¼é”çš„ç‰¹å¾"><a href="#åˆ†å¸ƒå¼é”çš„ç‰¹å¾" class="header-anchor">#</a> åˆ†å¸ƒå¼é”çš„ç‰¹å¾</h3> <p>ã€Œäº’æ–¥æ€§ã€: ä»»æ„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”ã€‚</p> <p>ã€Œé”è¶…æ—¶é‡Šæ”¾ã€ï¼šæŒæœ‰é”è¶…æ—¶ï¼Œå¯ä»¥é‡Šæ”¾ï¼Œé˜²æ­¢ä¸å¿…è¦çš„èµ„æºæµªè´¹ï¼Œä¹Ÿå¯ä»¥é˜²æ­¢æ­»é”ã€‚</p> <p>ã€Œå¯é‡å…¥æ€§ã€:ä¸€ä¸ªçº¿ç¨‹å¦‚æœè·å–äº†é”ä¹‹å,å¯ä»¥å†æ¬¡å¯¹å…¶è¯·æ±‚åŠ é”ã€‚</p> <p>ã€Œé«˜æ€§èƒ½å’Œé«˜å¯ç”¨ã€ï¼šåŠ é”å’Œè§£é”éœ€è¦å¼€é”€å°½å¯èƒ½ä½ï¼ŒåŒæ—¶ä¹Ÿè¦ä¿è¯é«˜å¯ç”¨ï¼Œé¿å…åˆ†å¸ƒå¼é”å¤±æ•ˆã€‚</p> <p>ã€Œå®‰å…¨æ€§ã€ï¼šé”åªèƒ½è¢«æŒæœ‰çš„å®¢æˆ·ç«¯åˆ é™¤ï¼Œä¸èƒ½è¢«å…¶ä»–å®¢æˆ·ç«¯åˆ é™¤</p> <h3 id="åˆ†å¸ƒå¼é”çš„å®ç°"><a href="#åˆ†å¸ƒå¼é”çš„å®ç°" class="header-anchor">#</a> åˆ†å¸ƒå¼é”çš„å®ç°</h3> <h4 id="mysql"><a href="#mysql" class="header-anchor">#</a> MySQL</h4> <p>ä¹è§‚é”ã€æ‚²è§‚é”</p> <h4 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h4> <ul><li>setnx + expire</li> <li>setnx + valueå€¼æ˜¯è¿‡æœŸæ—¶é—´</li> <li>setçš„æ‰©å±•å‘½ä»¤ï¼ˆset ex px nxï¼‰</li> <li>set ex px nx + æ ¡éªŒå”¯ä¸€éšæœºå€¼,å†åˆ é™¤</li> <li>Redisson</li> <li>Redisson + RedLock</li></ul> <h4 id="zookeeper"><a href="#zookeeper" class="header-anchor">#</a> ZooKeeper</h4> <h2 id="åˆ†å¸ƒå¼é”-2"><a href="#åˆ†å¸ƒå¼é”-2" class="header-anchor">#</a> åˆ†å¸ƒå¼é”</h2> <p>æˆ‘ä»¬çš„ç³»ç»Ÿå¤§éƒ¨åˆ†éƒ½æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²çš„ï¼Œæ—¥å¸¸å¼€å‘ä¸­ï¼Œ<strong>ç§’æ€ä¸‹å•ã€æŠ¢è´­å•†å“</strong> ç­‰ç­‰ä¸šåŠ¡åœºæ™¯ï¼Œä¸ºäº†é˜²â½Œ<strong>åº“å­˜è¶…å–</strong>ï¼Œéƒ½éœ€è¦ç”¨åˆ°<strong>åˆ†å¸ƒå¼é”</strong>ã€‚</p> <blockquote><p>åˆ†å¸ƒå¼é”å…¶å®å°±æ˜¯ï¼Œæ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¸åŒè¿›ç¨‹å…±åŒè®¿é—®å…±äº«èµ„æºçš„ä¸€ç§é”çš„å®ç°ã€‚å¦‚æœä¸åŒçš„ç³»ç»Ÿæˆ–åŒä¸€ä¸ªç³»ç»Ÿçš„ä¸åŒä¸»æœºä¹‹é—´å…±äº«äº†æŸä¸ªä¸´ç•Œèµ„æºï¼Œå¾€å¾€éœ€è¦äº’æ–¥æ¥é˜²æ­¢å½¼æ­¤å¹²æ‰°ï¼Œä»¥ä¿è¯ä¸€è‡´æ€§ã€‚</p></blockquote> <p>ä¸šç•Œæµè¡Œçš„åˆ†å¸ƒå¼é”å®ç°ï¼Œä¸€èˆ¬æœ‰è¿™3ç§æ–¹å¼ï¼š</p> <ul><li>åŸºäºæ•°æ®åº“å®ç°çš„åˆ†å¸ƒå¼é”</li> <li>åŸºäºRediså®ç°çš„åˆ†å¸ƒå¼é”</li> <li>åŸºäºZookeeperå®ç°çš„åˆ†å¸ƒå¼é”</li></ul> <h3 id="åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”"><a href="#åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”" class="header-anchor">#</a> åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”</h3> <h4 id="æ‚²è§‚é”å®ç°"><a href="#æ‚²è§‚é”å®ç°" class="header-anchor">#</a> æ‚²è§‚é”å®ç°</h4> <h4 id="ä¹è§‚é”å®ç°"><a href="#ä¹è§‚é”å®ç°" class="header-anchor">#</a> ä¹è§‚é”å®ç°</h4> <p>ä¹è§‚é”ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆä¹è§‚ï¼Œæ¯æ¬¡æ›´æ–°æ“ä½œï¼Œéƒ½è§‰å¾—ä¸ä¼šå­˜åœ¨å¹¶å‘å†²çªï¼Œåªæœ‰æ›´æ–°å¤±è´¥åï¼Œæ‰é‡è¯•ã€‚å®ƒæ˜¯åŸºäºCASæ€æƒ³å®ç°çš„ã€‚å¦‚ï¼š<strong>æ‰£å‡ä½™é¢</strong></p> <blockquote><p>æä¸ªversionå­—æ®µï¼Œæ¯æ¬¡æ›´æ–°ä¿®æ”¹ï¼Œéƒ½ä¼šè‡ªå¢åŠ ä¸€ï¼Œç„¶åå»æ›´æ–°ä½™é¢æ—¶ï¼ŒæŠŠæŸ¥å‡ºæ¥çš„é‚£ä¸ªç‰ˆæœ¬å·ï¼Œå¸¦ä¸Šæ¡ä»¶å»æ›´æ–°ï¼Œå¦‚æœæ˜¯ä¸Šæ¬¡é‚£ä¸ªç‰ˆæœ¬å·ï¼Œå°±æ›´æ–°ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¡¨ç¤ºåˆ«äººå¹¶å‘ä¿®æ”¹è¿‡äº†ï¼Œå°±ç»§ç»­é‡è¯•ã€‚</p></blockquote> <p>1ã€æŸ¥è¯¢ç‰ˆæœ¬å·å’Œä½™é¢</p> <p>2ã€å¦‚æœç‰ˆæœ¬å·ç¬¦åˆï¼Œåˆ¤æ–­ä½™é¢æ˜¯å¦å……è¶³</p> <p>3ã€æ‰£å‡ä½™é¢</p> <h3 id="åŸºäºrediså®ç°åˆ†å¸ƒå¼é”"><a href="#åŸºäºrediså®ç°åˆ†å¸ƒå¼é”" class="header-anchor">#</a> åŸºäºRediså®ç°åˆ†å¸ƒå¼é”</h3> <p>Redisåˆ†å¸ƒå¼é”ä¸€èˆ¬æœ‰ä»¥ä¸‹è¿™å‡ ç§å®ç°æ–¹å¼ï¼š</p> <ul><li>setnx + expire</li> <li>setnx + valueå€¼æ˜¯è¿‡æœŸæ—¶é—´</li> <li>setçš„æ‰©å±•å‘½ä»¤ï¼ˆset ex px nxï¼‰</li> <li>set ex px nx + æ ¡éªŒå”¯ä¸€éšæœºå€¼,å†åˆ é™¤</li> <li>Redisson</li> <li>Redisson + RedLock</li></ul> <h4 id="setnx-expire"><a href="#setnx-expire" class="header-anchor">#</a> setnx + expire</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span>ï¼ˆjedis<span class="token punctuation">.</span><span class="token function">setnx</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>lock_value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>ï¼‰<span class="token punctuation">{</span> <span class="token comment">//setnxåŠ é”</span>
    expireï¼ˆkeyï¼Œ<span class="token number">100</span>ï¼‰<span class="token punctuation">;</span> <span class="token comment">//è®¾ç½®è¿‡æœŸæ—¶é—´</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> something  <span class="token comment">//ä¸šåŠ¡å¤„ç†</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       jedis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//é‡Šæ”¾é”</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™æ®µä»£ç æ˜¯å¯ä»¥åŠ é”æˆåŠŸï¼Œä½†æ˜¯<strong>åŠ é”æ“ä½œå’Œè®¾ç½®è¶…æ—¶æ—¶é—´æ˜¯åˆ†å¼€çš„ã€‚å‡è®¾åœ¨æ‰§è¡Œå®Œ<code>setnx</code>åŠ é”åï¼Œæ­£è¦æ‰§è¡Œ<code>expire</code>è®¾ç½®è¿‡æœŸæ—¶é—´æ—¶ï¼Œè¿›ç¨‹<code>crash</code>æ‰æˆ–è€…è¦é‡å¯ç»´æŠ¤äº†ï¼Œé‚£è¿™ä¸ªé”å°±</strong>é•¿ç”Ÿä¸è€<strong>äº†ï¼Œåˆ«çš„çº¿ç¨‹æ°¸è¿œè·å–ä¸åˆ°é”å•¦ï¼Œæ‰€ä»¥</strong>åˆ†å¸ƒå¼é”ä¸èƒ½è¿™ä¹ˆå®ç°ï¼</p> <h4 id="setnx-valueå€¼æ˜¯è¿‡æœŸæ—¶é—´"><a href="#setnx-valueå€¼æ˜¯è¿‡æœŸæ—¶é—´" class="header-anchor">#</a> setnx + valueå€¼æ˜¯è¿‡æœŸæ—¶é—´</h4> <div class="language- extra-class"><pre class="language-text"><code>long expires = System.currentTimeMillis() + expireTime; //ç³»ç»Ÿæ—¶é—´+è®¾ç½®çš„è¿‡æœŸæ—¶é—´
String expiresStr = String.valueOf(expires);
 
// å¦‚æœå½“å‰é”ä¸å­˜åœ¨ï¼Œè¿”å›åŠ é”æˆåŠŸ
if (jedis.setnx(key, expiresStr) == 1) {
        return true;
} 
// å¦‚æœé”å·²ç»å­˜åœ¨ï¼Œè·å–é”çš„è¿‡æœŸæ—¶é—´
String currentValueStr = jedis.get(key);
 
// å¦‚æœè·å–åˆ°çš„è¿‡æœŸæ—¶é—´ï¼Œå°äºç³»ç»Ÿå½“å‰æ—¶é—´ï¼Œè¡¨ç¤ºå·²ç»è¿‡æœŸ
if (currentValueStr != null &amp;&amp; Long.parseLong(currentValueStr) &lt; System.currentTimeMillis()) {
 
     // é”å·²è¿‡æœŸï¼Œè·å–ä¸Šä¸€ä¸ªé”çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶è®¾ç½®ç°åœ¨é”çš„è¿‡æœŸæ—¶é—´ï¼ˆä¸äº†è§£redisçš„getSetå‘½ä»¤çš„å°ä¼™ä¼´ï¼Œå¯ä»¥å»å®˜ç½‘çœ‹ä¸‹å“ˆï¼‰
    String oldValueStr = jedis.getSet(key, expiresStr);
    
    if (oldValueStr != null &amp;&amp; oldValueStr.equals(currentValueStr)) {
         // è€ƒè™‘å¤šçº¿ç¨‹å¹¶å‘çš„æƒ…å†µï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„è®¾ç½®å€¼å’Œå½“å‰å€¼ç›¸åŒï¼Œå®ƒæ‰å¯ä»¥åŠ é”
         return true;
    }
}
        
//å…¶ä»–æƒ…å†µï¼Œå‡è¿”å›åŠ é”å¤±è´¥
return false;
}
</code></pre></div><p>è¿™ä¹ˆå®ç°åˆ†å¸ƒå¼é”çš„ï¼Œä½†æ˜¯ä¼šæœ‰è¿™äº›<strong>ç¼ºç‚¹</strong>ï¼š</p> <ul><li>è¿‡æœŸæ—¶é—´æ˜¯å®¢æˆ·ç«¯è‡ªå·±ç”Ÿæˆçš„ï¼Œåˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œ<strong>æ¯ä¸ªå®¢æˆ·ç«¯çš„æ—¶é—´å¿…é¡»åŒæ­¥ã€‚</strong></li> <li>æ²¡æœ‰ä¿å­˜æŒæœ‰è€…çš„å”¯ä¸€æ ‡è¯†ï¼Œ<strong>å¯èƒ½è¢«åˆ«çš„å®¢æˆ·ç«¯é‡Šæ”¾/è§£é”</strong>ã€‚</li> <li>é”è¿‡æœŸçš„æ—¶å€™ï¼Œå¹¶å‘å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯·æ±‚è¿‡æ¥ï¼Œéƒ½æ‰§è¡Œäº†<code>jedis.getSet()</code>ï¼Œæœ€ç»ˆåªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯åŠ é”æˆåŠŸï¼Œä½†æ˜¯è¯¥å®¢æˆ·ç«¯é”çš„è¿‡æœŸæ—¶é—´ï¼Œ<strong>å¯èƒ½è¢«åˆ«çš„å®¢æˆ·ç«¯è¦†ç›–ã€‚</strong></li></ul> <h4 id="setçš„æ‹“å±•å‘½ä»¤-set-ex-px-nx"><a href="#setçš„æ‹“å±•å‘½ä»¤-set-ex-px-nx" class="header-anchor">#</a> setçš„æ‹“å±•å‘½ä»¤ï¼ˆset ex px nxï¼‰</h4> <p>è¿™ä¸ªå‘½ä»¤çš„å‡ ä¸ªå‚æ•°åˆ†åˆ«è¡¨ç¤ºä»€ä¹ˆæ„æ€å‘¢ï¼Ÿè·Ÿå¤§å®¶å¤ä¹ ä¸€ä¸‹ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code>SET key value <span class="token punctuation">[</span>EX seconds<span class="token punctuation">]</span> <span class="token punctuation">[</span>PX milliseconds<span class="token punctuation">]</span> <span class="token punctuation">[</span>NX<span class="token operator">|</span>XX<span class="token punctuation">]</span>
</code></pre></div><ul><li>EX second ï¼šè®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ä¸º<code>second</code>ç§’ã€‚</li> <li>PX millisecond ï¼šè®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ä¸º<code>millisecond</code>æ¯«ç§’ã€‚</li> <li>NX ï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œã€‚</li> <li>XX ï¼šåªåœ¨é”®å·²ç»å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œã€‚</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span>ï¼ˆjedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> <span class="token string">&quot;NX&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;EX&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span>s<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>ï¼‰<span class="token punctuation">{</span> <span class="token comment">//åŠ é”</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> something  <span class="token comment">//ä¸šåŠ¡å¤„ç†</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       jedis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//é‡Šæ”¾é”</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™ä¸ªæ–¹æ¡ˆå¯èƒ½å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š</p> <ul><li>é”è¿‡æœŸé‡Šæ”¾äº†ï¼Œä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œã€‚</li> <li>é”è¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ ã€‚</li></ul> <p>å¯èƒ½ä¼šæœ‰ä¸ªç–‘é—®ï¼Œå°±æ˜¯<strong>é”ä¸ºä»€ä¹ˆä¼šè¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ </strong>å‘¢ï¼Ÿå‡è®¾å¹¶å‘å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œ<strong>çº¿ç¨‹Aè·å¾—äº†é”ï¼Œä½†æ˜¯å®ƒæ²¡é‡Šæ”¾é”çš„è¯ï¼Œçº¿ç¨‹Bæ˜¯è·å–ä¸åˆ°é”çš„</strong>ï¼Œæ‰€ä»¥æŒ‰é“ç†å®ƒæ˜¯æ‰§è¡Œä¸åˆ°åŠ é”ä¸‹é¢çš„ä»£ç æ»´ï¼Œæ€ä¹ˆä¼šå¯¼è‡´é”è¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ å‘¢ï¼Ÿ</p> <blockquote><p>å‡è®¾çº¿ç¨‹Aå’ŒBï¼Œéƒ½æƒ³ç”¨<code>key</code>åŠ é”ï¼Œæœ€åAæŠ¢åˆ°é”åŠ é”æˆåŠŸï¼Œä½†æ˜¯ç”±äºæ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„è€—æ—¶å¾ˆé•¿ï¼Œè¶…è¿‡äº†è®¾ç½®çš„è¶…æ—¶æ—¶é—´<code>100s</code>ã€‚è¿™æ—¶å€™ï¼ŒRediså°±è‡ªåŠ¨é‡Šæ”¾äº†<code>key</code>é”ã€‚è¿™æ—¶å€™çº¿ç¨‹Bå°±å¯ä»¥åŠ é”æˆåŠŸäº†ï¼Œæ¥ä¸‹å•¦ï¼Œå®ƒä¹Ÿæ‰§è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚å‡è®¾ç¢°å·§è¿™æ—¶å€™ï¼ŒAæ‰§è¡Œå®Œè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œå®ƒå°±å»é‡Šæ”¾é”ï¼Œä½†æ˜¯å®ƒå°±æŠŠBçš„é”ç»™é‡Šæ”¾äº†ã€‚</p></blockquote> <h4 id="set-ex-px-nx-æ ¡éªŒå”¯ä¸€éšæœºå€¼-å†åˆ é™¤"><a href="#set-ex-px-nx-æ ¡éªŒå”¯ä¸€éšæœºå€¼-å†åˆ é™¤" class="header-anchor">#</a> set ex px nx + æ ¡éªŒå”¯ä¸€éšæœºå€¼,å†åˆ é™¤</h4> <p>ä¸ºäº†è§£å†³<strong>é”è¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ </strong>é—®é¢˜ã€‚å¯ä»¥åœ¨<code>set ex px nx</code>çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šä¸ªæ ¡éªŒçš„å”¯ä¸€éšæœºå€¼ï¼Œå¦‚ä¸‹ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span>ï¼ˆjedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> uni_request_id<span class="token punctuation">,</span> <span class="token string">&quot;NX&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;EX&quot;</span><span class="token punctuation">,</span> 100s<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>ï¼‰<span class="token punctuation">{</span> <span class="token comment">//åŠ é”</span>
    try <span class="token punctuation">{</span>
        do something  <span class="token comment">//ä¸šåŠ¡å¤„ç†</span>
    <span class="token punctuation">}</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        
  	<span class="token punctuation">}</span>
  	finally <span class="token punctuation">{</span>
       <span class="token comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹åŠ çš„é”,æ˜¯æ‰é‡Šæ”¾</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>uni_request_id<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          jedis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//é‡Šæ”¾é”</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨è¿™é‡Œï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹åŠ çš„é”å’Œé‡Šæ”¾é”<strong>ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ</strong>ã€‚å¦‚æœè°ƒç”¨<code>jedis.del()</code>é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå¯èƒ½<strong>è¿™æŠŠé”å·²ç»ä¸å±äºå½“å‰å®¢æˆ·ç«¯</strong>ï¼Œä¼šè§£é™¤ä»–äººåŠ çš„é”ã€‚</p> <p>ä¸€èˆ¬å¯ä»¥ç”¨luaè„šæœ¬æ¥åŒ…ä¸€ä¸‹ã€‚luaè„šæœ¬å¦‚ä¸‹ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token char">'get'</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> then 
   <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token char">'del'</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token keyword">else</span>
   <span class="token keyword">return</span> <span class="token number">0</span>
end<span class="token punctuation">;</span>
</code></pre></div><p>è¿™ç§æ–¹å¼æ¯”è¾ƒä¸é”™äº†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå·²ç»å¯ä»¥ä½¿ç”¨è¿™ç§å®ç°æ–¹å¼ã€‚ä½†æ˜¯è¿˜æ˜¯å­˜åœ¨ï¼š<strong>é”è¿‡æœŸé‡Šæ”¾äº†ï¼Œä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œçš„é—®é¢˜</strong>ã€‚</p> <h4 id="redisson"><a href="#redisson" class="header-anchor">#</a> Redisson</h4> <p>å¯¹äºå¯èƒ½å­˜åœ¨<strong>é”è¿‡æœŸé‡Šæ”¾ï¼Œä¸šåŠ¡æ²¡æ‰§è¡Œå®Œ</strong>çš„é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥ç¨å¾®æŠŠé”è¿‡æœŸæ—¶é—´è®¾ç½®é•¿ä¸€äº›ï¼Œå¤§äºæ­£å¸¸ä¸šåŠ¡å¤„ç†æ—¶é—´å°±å¥½å•¦ã€‚</p> <p>å¦‚æœä½ è§‰å¾—ä¸æ˜¯å¾ˆç¨³ï¼Œè¿˜å¯ä»¥ç»™è·å¾—é”çš„çº¿ç¨‹ï¼Œå¼€å¯ä¸€ä¸ªå®šæ—¶å®ˆæŠ¤çº¿ç¨‹ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥é”æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å¯¹é”çš„è¿‡æœŸæ—¶é—´å»¶é•¿ï¼Œé˜²æ­¢é”è¿‡æœŸæå‰é‡Šæ”¾ã€‚</p> <p>å½“å‰å¼€æºæ¡†æ¶Redissonè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å¯ä»¥çœ‹ä¸‹Redissonåº•å±‚åŸç†å›¾ï¼š</p> <p>åªè¦çº¿ç¨‹ä¸€åŠ é”æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ª<code>watch dog</code>çœ‹é—¨ç‹—ï¼Œå®ƒæ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¼šæ¯éš”10ç§’æ£€æŸ¥ä¸€ä¸‹ï¼Œå¦‚æœçº¿ç¨‹1è¿˜æŒæœ‰é”ï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–­çš„å»¶é•¿é”keyçš„ç”Ÿå­˜æ—¶é—´ã€‚å› æ­¤ï¼ŒRedissonå°±æ˜¯ä½¿ç”¨<code>watch dog</code>è§£å†³äº†<strong>é”è¿‡æœŸé‡Šæ”¾ï¼Œä¸šåŠ¡æ²¡æ‰§è¡Œå®Œé—®é¢˜</strong>ã€‚</p> <h4 id="redisson-redlock"><a href="#redisson-redlock" class="header-anchor">#</a> Redisson + RedLock</h4> <p>å‰é¢å…­ç§æ–¹æ¡ˆéƒ½åªæ˜¯åŸºäº<strong>Rediså•æœºç‰ˆ</strong>çš„åˆ†å¸ƒå¼é”è®¨è®ºï¼Œè¿˜ä¸æ˜¯å¾ˆå®Œç¾ã€‚å› ä¸º<strong>Redis</strong>ä¸€èˆ¬éƒ½æ˜¯é›†ç¾¤éƒ¨ç½²çš„ï¼š</p> <p>å¦‚æœçº¿ç¨‹ä¸€åœ¨<code>Redis</code>çš„<code>master</code>èŠ‚ç‚¹ä¸Šæ‹¿åˆ°äº†é”ï¼Œä½†æ˜¯åŠ é”çš„<code>key</code>è¿˜æ²¡åŒæ­¥åˆ°<code>slave</code>èŠ‚ç‚¹ã€‚æ°å¥½è¿™æ—¶ï¼Œ<code>master</code>èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œä¸€ä¸ª<code>slave</code>èŠ‚ç‚¹å°±ä¼šå‡çº§ä¸º<code>master</code>èŠ‚ç‚¹ã€‚çº¿ç¨‹äºŒå°±å¯ä»¥é¡ºç†æˆç« è·å–åŒä¸ª<code>key</code>çš„é”å•¦ï¼Œä½†çº¿ç¨‹ä¸€ä¹Ÿå·²ç»æ‹¿åˆ°é”äº†ï¼Œé”çš„å®‰å…¨æ€§å°±æ²¡äº†ã€‚</p> <p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedisä½œè€…antirezæå‡ºä¸€ç§é«˜çº§çš„åˆ†å¸ƒå¼é”ç®—æ³•ï¼š<strong>Redlock</strong>ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯è¿™æ ·çš„ï¼š</p> <blockquote><p>éƒ¨ç½²å¤šä¸ªRedis masterï¼Œä»¥ä¿è¯å®ƒä»¬ä¸ä¼šåŒæ—¶å®•æ‰ã€‚å¹¶ä¸”è¿™äº›masterèŠ‚ç‚¹æ˜¯å®Œå…¨ç›¸äº’ç‹¬ç«‹çš„ï¼Œç›¸äº’ä¹‹é—´ä¸å­˜åœ¨æ•°æ®åŒæ­¥ã€‚åŒæ—¶ï¼Œéœ€è¦ç¡®ä¿åœ¨è¿™å¤šä¸ªmasterå®ä¾‹ä¸Šï¼Œæ˜¯ä¸åœ¨Rediså•å®ä¾‹ï¼Œä½¿ç”¨ç›¸åŒæ–¹æ³•æ¥è·å–å’Œé‡Šæ”¾é”ã€‚</p></blockquote> <p>æˆ‘ä»¬å‡è®¾å½“å‰æœ‰5ä¸ªRedis masterèŠ‚ç‚¹ï¼Œåœ¨5å°æœåŠ¡å™¨ä¸Šé¢è¿è¡Œè¿™äº›Rediså®ä¾‹ã€‚</p> <p>RedLockçš„å®ç°æ­¥éª¤:</p> <ol><li>è·å–å½“å‰æ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚</li> <li><strong>æŒ‰é¡ºåºå‘5ä¸ªmasterèŠ‚ç‚¹è¯·æ±‚åŠ é”</strong>ã€‚å®¢æˆ·ç«¯è®¾ç½®ç½‘ç»œè¿æ¥å’Œå“åº”è¶…æ—¶æ—¶é—´ï¼Œå¹¶ä¸”<strong>è¶…æ—¶æ—¶é—´è¦å°äºé”çš„å¤±æ•ˆæ—¶é—´ã€‚</strong>ï¼ˆå‡è®¾é”è‡ªåŠ¨å¤±æ•ˆæ—¶é—´ä¸º10ç§’ï¼Œåˆ™è¶…æ—¶æ—¶é—´ä¸€èˆ¬åœ¨5-50æ¯«ç§’ä¹‹é—´,æˆ‘ä»¬å°±å‡è®¾è¶…æ—¶æ—¶é—´æ˜¯50mså§ï¼‰ã€‚å¦‚æœè¶…æ—¶ï¼Œè·³è¿‡è¯¥masterèŠ‚ç‚¹ï¼Œå°½å¿«å»å°è¯•ä¸‹ä¸€ä¸ªmasterèŠ‚ç‚¹ã€‚</li> <li>å®¢æˆ·ç«¯ä½¿ç”¨å½“å‰æ—¶é—´å‡å»å¼€å§‹è·å–é”æ—¶é—´ï¼ˆå³æ­¥éª¤1è®°å½•çš„æ—¶é—´ï¼‰ï¼Œå¾—åˆ°è·å–é”ä½¿ç”¨çš„æ—¶é—´ã€‚<strong>å½“ä¸”ä»…å½“è¶…è¿‡ä¸€åŠï¼ˆN/2+1ï¼Œè¿™é‡Œæ˜¯5/2+1=3ä¸ªèŠ‚ç‚¹ï¼‰çš„Redis masterèŠ‚ç‚¹éƒ½è·å¾—é”ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ—¶é—´å°äºé”å¤±æ•ˆæ—¶é—´æ—¶ï¼Œé”æ‰ç®—è·å–æˆåŠŸã€‚</strong>ï¼ˆå¦‚ä¸Šå›¾ï¼Œ10s&gt; 30ms+40ms+50ms+4m0s+50msï¼‰</li> <li>å¦‚æœå–åˆ°äº†é”ï¼Œkeyçš„çœŸæ­£æœ‰æ•ˆæ—¶é—´å°±å˜å•¦ï¼Œéœ€è¦å‡å»è·å–é”æ‰€ä½¿ç”¨çš„æ—¶é—´ã€‚</li> <li>å¦‚æœè·å–é”å¤±è´¥ï¼ˆæ²¡æœ‰åœ¨è‡³å°‘N/2+1ä¸ªmasterå®ä¾‹å–åˆ°é”ï¼Œæœ‰æˆ–è€…è·å–é”æ—¶é—´å·²ç»è¶…è¿‡äº†æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œå®¢æˆ·ç«¯è¦åœ¨æ‰€æœ‰çš„masterèŠ‚ç‚¹ä¸Šè§£é”ï¼ˆå³ä¾¿æœ‰äº›masterèŠ‚ç‚¹æ ¹æœ¬å°±æ²¡æœ‰åŠ é”æˆåŠŸï¼Œä¹Ÿéœ€è¦è§£é”ï¼Œä»¥é˜²æ­¢æœ‰äº›æ¼ç½‘ä¹‹é±¼ï¼‰ã€‚</li></ol> <p>ç®€åŒ–ä¸‹æ­¥éª¤å°±æ˜¯ï¼š</p> <ul><li>æŒ‰é¡ºåºå‘5ä¸ªmasterèŠ‚ç‚¹è¯·æ±‚åŠ é”</li> <li>æ ¹æ®è®¾ç½®çš„è¶…æ—¶æ—¶é—´æ¥åˆ¤æ–­ï¼Œæ˜¯ä¸æ˜¯è¦è·³è¿‡è¯¥masterèŠ‚ç‚¹ã€‚</li> <li>å¦‚æœå¤§äºç­‰äº3ä¸ªèŠ‚ç‚¹åŠ é”æˆåŠŸï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ—¶é—´å°äºé”çš„æœ‰æ•ˆæœŸï¼Œå³å¯è®¤å®šåŠ é”æˆåŠŸå•¦ã€‚</li> <li>å¦‚æœè·å–é”å¤±è´¥ï¼Œè§£é”ï¼</li></ul> <h3 id="zookeeperåˆ†å¸ƒå¼é”"><a href="#zookeeperåˆ†å¸ƒå¼é”" class="header-anchor">#</a> Zookeeperåˆ†å¸ƒå¼é”</h3> <p>Zookeeperçš„èŠ‚ç‚¹Znodeæœ‰å››ç§ç±»å‹ï¼š</p> <ul><li><strong>æŒä¹…èŠ‚ç‚¹</strong>ï¼šé»˜è®¤çš„èŠ‚ç‚¹ç±»å‹ã€‚åˆ›å»ºèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹ä¾æ—§å­˜åœ¨ã€‚</li> <li><strong>æŒä¹…èŠ‚ç‚¹é¡ºåºèŠ‚ç‚¹</strong>ï¼šæ‰€è°“é¡ºåºèŠ‚ç‚¹ï¼Œå°±æ˜¯åœ¨åˆ›å»ºèŠ‚ç‚¹æ—¶ï¼ŒZookeeperæ ¹æ®åˆ›å»ºçš„æ—¶é—´é¡ºåºç»™è¯¥èŠ‚ç‚¹åç§°è¿›è¡Œç¼–å·ï¼ŒæŒä¹…èŠ‚ç‚¹é¡ºåºèŠ‚ç‚¹å°±æ˜¯æœ‰é¡ºåºçš„æŒä¹…èŠ‚ç‚¹ã€‚</li> <li><strong>ä¸´æ—¶èŠ‚ç‚¹</strong>ï¼šå’ŒæŒä¹…èŠ‚ç‚¹ç›¸åï¼Œå½“åˆ›å»ºèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œä¸´æ—¶èŠ‚ç‚¹ä¼šè¢«åˆ é™¤ã€‚</li> <li><strong>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹</strong>ï¼šæœ‰é¡ºåºçš„ä¸´æ—¶èŠ‚ç‚¹ã€‚</li></ul> <p>Zookeeperåˆ†å¸ƒå¼é”å®ç°åº”ç”¨äº†<strong>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹</strong>ã€‚è¿™é‡Œä¸è´´ä»£ç å•¦ï¼Œæ¥è®²ä¸‹zkåˆ†å¸ƒå¼é”çš„å®ç°åŸç†å§ã€‚</p> <h4 id="_4-1-zkè·å–é”è¿‡ç¨‹"><a href="#_4-1-zkè·å–é”è¿‡ç¨‹" class="header-anchor">#</a> 4.1 zkè·å–é”è¿‡ç¨‹</h4> <p>å½“ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚è¿‡æ¥æ—¶ï¼ŒZookeeperå®¢æˆ·ç«¯ä¼šåˆ›å»ºä¸€ä¸ªæŒä¹…èŠ‚ç‚¹<code>locks</code>ã€‚å¦‚æœå®ƒï¼ˆClient1ï¼‰æƒ³è·å¾—é”ï¼Œéœ€è¦åœ¨<code>locks</code>èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªé¡ºåºèŠ‚ç‚¹<code>lock1</code>.å¦‚å›¾</p> <p>æ¥ç€ï¼Œå®¢æˆ·ç«¯Client1ä¼šæŸ¥æ‰¾<code>locks</code>ä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„èŠ‚ç‚¹<code>lock1</code>æ˜¯ä¸æ˜¯æ’åºæœ€å°çš„é‚£ä¸€ä¸ªï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æˆåŠŸè·å¾—é”ã€‚</p> <p>è¿™æ—¶å€™å¦‚æœåˆæ¥ä¸€ä¸ªå®¢æˆ·ç«¯client2å‰æ¥å°è¯•è·å¾—é”ï¼Œå®ƒä¼šåœ¨locksä¸‹å†åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹<code>lock2</code></p> <p>å®¢æˆ·ç«¯client2ä¸€æ ·ä¹Ÿä¼šæŸ¥æ‰¾locksä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„èŠ‚ç‚¹lock2æ˜¯ä¸æ˜¯æœ€å°çš„ï¼Œæ­¤æ—¶ï¼Œå‘ç°lock1æ‰æ˜¯æœ€å°çš„ï¼Œäºæ˜¯è·å–é”å¤±è´¥ã€‚è·å–é”å¤±è´¥ï¼Œå®ƒæ˜¯ä¸ä¼šç”˜å¿ƒçš„ï¼Œclient2å‘å®ƒæ’åºé å‰çš„èŠ‚ç‚¹lock1æ³¨å†ŒWatcheräº‹ä»¶ï¼Œç”¨æ¥ç›‘å¬lock1æ˜¯å¦å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´client2æŠ¢é”å¤±è´¥è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p> <p>æ­¤æ—¶ï¼Œå¦‚æœå†æ¥ä¸€ä¸ªå®¢æˆ·ç«¯Client3æ¥å°è¯•è·å–é”ï¼Œå®ƒä¼šåœ¨locksä¸‹å†åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹lock3</p> <p>åŒæ ·çš„ï¼Œclient3ä¸€æ ·ä¹Ÿä¼šæŸ¥æ‰¾locksä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„èŠ‚ç‚¹lock3æ˜¯ä¸æ˜¯æœ€å°çš„ï¼Œå‘ç°è‡ªå·±ä¸æ˜¯æœ€å°çš„ï¼Œå°±è·å–é”å¤±è´¥ã€‚å®ƒä¹Ÿæ˜¯ä¸ä¼šç”˜å¿ƒçš„ï¼Œå®ƒä¼šå‘åœ¨å®ƒå‰é¢çš„èŠ‚ç‚¹lock2æ³¨å†ŒWatcheräº‹ä»¶ï¼Œä»¥ç›‘å¬lock2èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚</p> <h4 id="_4-2-é‡Šæ”¾é”"><a href="#_4-2-é‡Šæ”¾é”" class="header-anchor">#</a> 4.2 é‡Šæ”¾é”</h4> <p>æˆ‘ä»¬å†æ¥çœ‹çœ‹é‡Šæ”¾é”çš„æµç¨‹ï¼ŒZookeeperçš„å®¢æˆ·ç«¯ä¸šåŠ¡å®Œæˆæˆ–è€…å‘ç”Ÿæ•…éšœï¼Œéƒ½ä¼šåˆ é™¤ä¸´æ—¶èŠ‚ç‚¹ï¼Œé‡Šæ”¾é”ã€‚å¦‚æœæ˜¯ä»»åŠ¡å®Œæˆï¼ŒClient1ä¼šæ˜¾å¼è°ƒç”¨åˆ é™¤lock1çš„æŒ‡ä»¤</p> <p>å¦‚æœæ˜¯å®¢æˆ·ç«¯æ•…éšœäº†ï¼Œæ ¹æ®ä¸´æ—¶èŠ‚ç‚¹å¾—ç‰¹æ€§ï¼Œlock1æ˜¯ä¼šè‡ªåŠ¨åˆ é™¤çš„</p> <p>lock1èŠ‚ç‚¹è¢«åˆ é™¤åï¼ŒClient2å¯å¼€å¿ƒäº†ï¼Œå› ä¸ºå®ƒä¸€ç›´ç›‘å¬ç€lock1ã€‚lock1èŠ‚ç‚¹åˆ é™¤ï¼ŒClient2ç«‹åˆ»æ”¶åˆ°é€šçŸ¥ï¼Œä¹Ÿä¼šæŸ¥æ‰¾locksä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œå‘ä¸‹lock2æ˜¯æœ€å°ï¼Œå°±è·å¾—é”ã€‚</p> <p>åŒç†ï¼ŒClient2è·å¾—é”ä¹‹åï¼ŒClient3ä¹Ÿå¯¹å®ƒè™è§†çœˆçœˆï¼Œå•Šå“ˆå“ˆ~</p> <ul><li><strong>Zookeeperè®¾è®¡å®šä½å°±æ˜¯åˆ†å¸ƒå¼åè°ƒï¼Œç®€å•æ˜“ç”¨</strong>ã€‚å¦‚æœè·å–ä¸åˆ°é”ï¼Œåªéœ€æ·»åŠ ä¸€ä¸ªç›‘å¬å™¨å³å¯ï¼Œå¾ˆé€‚åˆåšåˆ†å¸ƒå¼é”ã€‚</li> <li>Zookeeperä½œä¸ºåˆ†å¸ƒå¼é”ä¹Ÿç¼ºç‚¹ï¼šå¦‚æœæœ‰å¾ˆå¤šçš„å®¢æˆ·ç«¯é¢‘ç¹çš„ç”³è¯·åŠ é”ã€é‡Šæ”¾é”ï¼Œå¯¹äºZookeeperé›†ç¾¤çš„å‹åŠ›ä¼šæ¯”è¾ƒå¤§ã€‚</li></ul> <h3 id="_5-ä¸‰ç§åˆ†å¸ƒå¼é”å¯¹æ¯”"><a href="#_5-ä¸‰ç§åˆ†å¸ƒå¼é”å¯¹æ¯”" class="header-anchor">#</a> 5. ä¸‰ç§åˆ†å¸ƒå¼é”å¯¹æ¯”</h3> <h4 id="_5-1-æ•°æ®åº“åˆ†å¸ƒå¼é”å®ç°"><a href="#_5-1-æ•°æ®åº“åˆ†å¸ƒå¼é”å®ç°" class="header-anchor">#</a> 5.1 æ•°æ®åº“åˆ†å¸ƒå¼é”å®ç°</h4> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>ç®€å•ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œä¸éœ€è¦å¼•å…¥<code>Redisã€zookeeper</code>ç­‰ä¸­é—´ä»¶ã€‚</li></ul> <p>ç¼ºç‚¹ï¼š</p> <ul><li>ä¸é€‚åˆé«˜å¹¶å‘çš„åœºæ™¯</li> <li>dbæ“ä½œæ€§èƒ½è¾ƒå·®ï¼›</li></ul> <h4 id="_5-2-redisåˆ†å¸ƒå¼é”å®ç°"><a href="#_5-2-redisåˆ†å¸ƒå¼é”å®ç°" class="header-anchor">#</a> 5.2 Redisåˆ†å¸ƒå¼é”å®ç°</h4> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>æ€§èƒ½å¥½ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯</li> <li>è¾ƒè½»é‡çº§</li> <li>æœ‰è¾ƒå¥½çš„æ¡†æ¶æ”¯æŒï¼Œå¦‚Redisson</li></ul> <p>ç¼ºç‚¹ï¼š</p> <ul><li>è¿‡æœŸæ—¶é—´ä¸å¥½æ§åˆ¶</li> <li>éœ€è¦è€ƒè™‘é”è¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ åœºæ™¯</li></ul> <h4 id="_5-3-zookeeperåˆ†å¸ƒå¼é”å®ç°"><a href="#_5-3-zookeeperåˆ†å¸ƒå¼é”å®ç°" class="header-anchor">#</a> 5.3 Zookeeperåˆ†å¸ƒå¼é”å®ç°</h4> <p>ç¼ºç‚¹ï¼š</p> <ul><li>æ€§èƒ½ä¸å¦‚rediså®ç°çš„åˆ†å¸ƒå¼é”</li> <li>æ¯”è¾ƒé‡çš„åˆ†å¸ƒå¼é”ã€‚</li></ul> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>æœ‰è¾ƒå¥½çš„æ€§èƒ½å’Œå¯é æ€§</li> <li>æœ‰å°è£…è¾ƒå¥½çš„æ¡†æ¶ï¼Œå¦‚Curator</li></ul> <h2 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="header-anchor">#</a> çº¿ç¨‹æ± </h2> <h3 id="çº¿ç¨‹æ± çš„ä½œç”¨"><a href="#çº¿ç¨‹æ± çš„ä½œç”¨" class="header-anchor">#</a> çº¿ç¨‹æ± çš„ä½œç”¨</h3> <ul><li>é™ä½èµ„æºçš„æ¶ˆè€—</li> <li>æé«˜å“åº”é€Ÿåº¦</li> <li>æé«˜çº¿ç¨‹çš„å®¢è§‚ç†æ€§</li></ul> <h3 id="å½“ä¸€ä¸ªæ–°ä»»åŠ¡åˆ°è¾¾çº¿ç¨‹æ± æ—¶-å…¶å¤„ç†æµç¨‹"><a href="#å½“ä¸€ä¸ªæ–°ä»»åŠ¡åˆ°è¾¾çº¿ç¨‹æ± æ—¶-å…¶å¤„ç†æµç¨‹" class="header-anchor">#</a> å½“ä¸€ä¸ªæ–°ä»»åŠ¡åˆ°è¾¾çº¿ç¨‹æ± æ—¶ï¼Œå…¶å¤„ç†æµç¨‹ï¼Ÿ</h3> <p><img src="https://cdn.jsdelivr.net/gh/BXuan-Yang/blogImage/img/image-20230318225730749.png" alt="image-20230318225730749"></p> <ul><li>1ã€<strong>çº¿ç¨‹æ± åˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ± çš„çº¿ç¨‹æ˜¯å¦éƒ½åœ¨æ‰§è¡Œä»»åŠ¡ã€‚</strong></li></ul> <p>æ˜¯ï¼šè¿›å…¥ä¸‹ä¸ªæµç¨‹</p> <p>å¦ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<strong>å·¥ä½œçº¿ç¨‹</strong>æ¥æ‰§è¡Œä»»åŠ¡ï¼ˆéœ€è¦åŠ ä¸Šå…¨å±€é”ï¼‰</p> <p><strong>å·¥ä½œçº¿ç¨‹</strong>ï¼šçº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¼šå°†çº¿ç¨‹å°è£…æˆå·¥ä½œçº¿ç¨‹Workerï¼ŒWorkeråœ¨æ‰§è¡Œå®Œä»»åŠ¡åï¼Œè¿˜ä¼šå¾ªç¯è·å–å·¥ä½œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡æ¥æ‰§è¡Œ</p> <ul><li>2ã€<strong>çº¿ç¨‹æ± åˆ¤æ–­å·¥ä½œé˜Ÿåˆ—æ˜¯å¦å·²æ»¡</strong></li></ul> <p>æ˜¯ï¼šè¿›å…¥ä¸‹ä¸ªæµç¨‹</p> <p>å¦ï¼šå°†æ–°æäº¤çš„ä»»åŠ¡å­˜å‚¨åœ¨å·¥ä½œé˜Ÿåˆ—ä¸­</p> <ul><li>3ã€<strong>çº¿ç¨‹æ± åˆ¤æ–­çº¿ç¨‹æ± çš„çº¿ç¨‹æ˜¯å¦éƒ½å¤„äºå·¥ä½œçŠ¶æ€</strong></li></ul> <p>æ˜¯ï¼šäº¤ç»™é¥±å’Œç­–ç•¥æ¥å¤„ç†</p> <p>1ã€AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼ˆé»˜è®¤ç­–ç•¥ï¼‰</p> <p>2ã€CallerRunsPolicyï¼šåªç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</p> <p>3ã€DiscardOldestPolicyï¼šä¸¢å¼ƒé˜Ÿåˆ—é‡Œæœ€è¿‘çš„ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡</p> <p>4ã€DiscardPolicyï¼šä¸å¤„ç†ï¼Œç›´æ¥ä¸¢å¼ƒ</p> <p>å¦ï¼šåˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼ˆéœ€è¦åŠ ä¸Šå…¨å±€é”ï¼‰</p> <h3 id="ä»‹ç»ä¸€ä¸‹çº¿ç¨‹æ± çš„å‚æ•°"><a href="#ä»‹ç»ä¸€ä¸‹çº¿ç¨‹æ± çš„å‚æ•°" class="header-anchor">#</a> ä»‹ç»ä¸€ä¸‹çº¿ç¨‹æ± çš„å‚æ•°</h3> <p><img src="https://cdn.jsdelivr.net/gh/BXuan-Yang/blogImage/img/image-20230318224318411.png" alt="image-20230318224318411"></p> <ul><li><strong>corePoolSize</strong>ï¼šçº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°</li></ul> <p>å½“æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå³æ˜¯å…¶ä»–ç©ºé—²çš„åŸºæœ¬çº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œæ–°çš„ä»»åŠ¡ï¼Œä¹Ÿä¼šåˆ›å»ºè¿™ä¸ªçº¿ç¨‹ï¼Œç­‰åˆ°éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°å¤§äºçº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°çš„æ—¶å€™å°±ä¸å†åˆ›å»º;</p> <ul><li><strong>maximumPoolSize</strong>ï¼šçº¿ç¨‹æ± æœ€å¤§æ•°é‡</li></ul> <p>çº¿ç¨‹å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ã€‚å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œå¹¶ä¸”å·²åˆ›å»ºçš„çº¿ç¨‹æ•°å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ™çº¿ç¨‹æ± ä¼šå†åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚æ³¨æ„ï¼šå¦‚æœæ˜¯ä½¿ç”¨äº†ä¸Šè¿°çš„æ— ç•Œçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œå°±æ²¡å¿…è¦å¼€å¯è¿™ä¸ªæœ€å¤§çº¿ç¨‹æ•°çš„å‚æ•°;</p> <ul><li><strong>keepAliveTime</strong>ï¼šçº¿ç¨‹æ´»åŠ¨ä¿æŒæ—¶é—´</li></ul> <p>çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹ç©ºé—²åï¼Œå¯ä»¥å­˜æ´»çš„æœ€é•¿æ—¶é—´;</p> <ul><li><strong>TimeUnit</strong>ï¼šçº¿ç¨‹æ´»åŠ¨ä¿æŒæ—¶é—´çš„å•ä½</li></ul> <p>å­˜æ´»æ—¶é—´çš„å•ä½;</p> <ul><li><strong>workQueue</strong>ï¼šä»»åŠ¡é˜Ÿåˆ—ï¼ˆç”¨æ¥ä¿å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼‰</li></ul> <p>1ã€ArrayBlockingQueueï¼šæ˜¯ä¸€ä¸ªåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œè¿›å…¥é˜Ÿåˆ—çš„å…ƒç´ æŒ‰ç…§FIFOæ’åºï¼›</p> <p>2ã€LinkedBlockingQueueï¼šä¸€ä¸ªåŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ï¼Œå…ƒç´ æŒ‰ç…§FIFOæ’åºï¼Œååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueueï¼Œegï¼šExecutors.newFixedThreadPool()ï¼›</p> <p>3ã€SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸é«˜äºLinkedBlockingQueueã€‚egï¼šExecutors.newCachedThreadPool()ï¼›</p> <p>4ã€PriorityBlockingQueueï¼šä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§çš„æ— é™é˜»å¡é˜Ÿåˆ—ï¼›</p> <ul><li><strong>ThreadFactory</strong>ï¼šç”¨äºè®¾ç½®åˆ›å»ºçº¿ç¨‹çš„å·¥å‚</li></ul> <p>new ThreadFactoryBuilder().setNameFormat(&quot;xxx-task--%d&quot;).get();</p> <ul><li><strong>RejectedExecutionHandler</strong>ï¼šé¥±å’Œç­–ç•¥</li></ul> <p>1ã€AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼ˆé»˜è®¤ç­–ç•¥ï¼‰</p> <p>2ã€CallerRunsPolicyï¼šåªç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</p> <p>3ã€DiscardOldestPolicyï¼šä¸¢å¼ƒé˜Ÿåˆ—é‡Œæœ€è¿‘çš„ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡</p> <p>4ã€DiscardPolicyï¼šä¸å¤„ç†ï¼Œç›´æ¥ä¸¢å¼ƒ</p> <h3 id="çº¿ç¨‹æ± æœ‰å“ªäº›é¥±å’Œç­–ç•¥"><a href="#çº¿ç¨‹æ± æœ‰å“ªäº›é¥±å’Œç­–ç•¥" class="header-anchor">#</a> çº¿ç¨‹æ± æœ‰å“ªäº›é¥±å’Œç­–ç•¥ï¼Ÿ</h3> <p>1ã€<strong>AbortPolicy</strong>ï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼ˆé»˜è®¤ç­–ç•¥ï¼‰</p> <p>æŠ›å‡º RejectedExecutionException æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ï¼›</p> <p>2ã€<strong>CallerRunsPolicy</strong>ï¼šåªç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</p> <p>è°ƒç”¨æ‰§è¡Œè‡ªå·±çº¿ç¨‹è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯å†ç›´æ¥è°ƒç”¨ execute() æ–¹æ³•çš„çº¿ç¨‹ä¸­è¿è¡Œï¼ˆrunï¼‰è¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œå¦‚æœæ‰§è¡Œçº¿ç¨‹å…³é—­ï¼Œé‚£ä¹ˆä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚</p> <p>3ã€<strong>DiscardOldestPolicy</strong>ï¼šä¸¢å¼ƒé˜Ÿåˆ—é‡Œæœ€è¿‘çš„ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡</p> <p>4ã€<strong>DiscardPolicy</strong>ï¼šä¸å¤„ç†ï¼Œç›´æ¥ä¸¢å¼ƒ</p> <h3 id="çº¿ç¨‹æ± å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›"><a href="#çº¿ç¨‹æ± å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›" class="header-anchor">#</a> çº¿ç¨‹æ± å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›ï¼Ÿ</h3> <p>1ã€<strong>ArrayBlockingQueue</strong>ï¼šæ˜¯ä¸€ä¸ªåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œè¿›å…¥é˜Ÿåˆ—çš„å…ƒç´ æŒ‰ç…§FIFOæ’åºï¼›</p> <p>2ã€<strong>LinkedBlockingQueue</strong>ï¼šä¸€ä¸ªåŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ï¼Œå…ƒç´ æŒ‰ç…§FIFOæ’åºï¼Œååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueueï¼Œegï¼šExecutors.newFixedThreadPool()ï¼›</p> <p>3ã€<strong>SynchronousQueue</strong>ï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸é«˜äºLinkedBlockingQueueã€‚egï¼šExecutors.newCachedThreadPool()ï¼›</p> <p>4ã€<strong>PriorityBlockingQueue</strong>ï¼šä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§çš„æ— é™é˜»å¡é˜Ÿåˆ—ï¼›</p> <h3 id="å¦‚ä½•å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡"><a href="#å¦‚ä½•å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡" class="header-anchor">#</a> å¦‚ä½•å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡ï¼Ÿ</h3> <ul><li><strong>execute()æ–¹æ³•</strong></li></ul> <p><strong>ç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡</strong>ï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«çº¿ç¨‹æ± æ‰§è¡ŒæˆåŠŸã€‚</p> <ul><li><strong>submit()æ–¹æ³•</strong></li></ul> <p><strong>ç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡</strong>ï¼Œçº¿ç¨‹æ± ä¼šè¿”å›ä¸€ä¸ªfutureå¯¹è±¡ï¼Œé€šè¿‡futureå¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œå¯ä»¥ä½¿ç”¨future.get()æ–¹æ³•æ¥è·å¾—è¿”å›å€¼ã€‚</p> <h3 id="å¦‚ä½•å…³é—­çº¿ç¨‹æ± "><a href="#å¦‚ä½•å…³é—­çº¿ç¨‹æ± " class="header-anchor">#</a> å¦‚ä½•å…³é—­çº¿ç¨‹æ± ï¼Ÿ</h3> <ul><li><p><strong>shutdown</strong></p></li> <li><p><strong>shutdownNow</strong></p></li></ul> <p>ä½¿ç”¨äº†ä¸Šè¿°ä¸¤ä¸ªä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œéƒ½ä¼šä½¿å¾— isShutDown è¿”å› trueã€‚è‡³æ‰€æœ‰ä»»åŠ¡éƒ½å…³é—­åï¼Œè¡¨ç¤ºçº¿ç¨‹æ± å…³é—­æˆåŠŸï¼Œæ­¤æ—¶ isTerminated ä¼šè¿”å›true</p> <h3 id="å¦‚ä½•åˆç†çš„é…ç½®çº¿ç¨‹æ± "><a href="#å¦‚ä½•åˆç†çš„é…ç½®çº¿ç¨‹æ± " class="header-anchor">#</a> å¦‚ä½•åˆç†çš„é…ç½®çº¿ç¨‹æ± ï¼Ÿ</h3> <ul><li>ä»»åŠ¡çš„æ€§è´¨</li></ul> <p>CPUå¯†é›†å‹ä»»åŠ¡ï¼šå°½å¯èƒ½é…ç½®å°çš„çº¿ç¨‹ï¼Œå› ä¸ºæ˜¯ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œæ— éœ€ä¸€ç›´è¿›è¡Œçº¿ç¨‹çš„åˆ‡æ¢</p> <p>IOå¯†é›†å‹ä»»åŠ¡ï¼šå¹¶ä¸æ˜¯ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œå¯ä»¥é…ç½®å°½å¯èƒ½å¤šçš„çº¿ç¨‹ã€‚</p> <p>æ··åˆå‹ä»»åŠ¡ï¼šå¯ä»¥æ‹†åˆ†æˆä¸€ä¸ªCPUå¯†é›†å‹çš„ä»»åŠ¡å’Œä¸€ä¸ªIOå¯†é›†å‹çš„ä»»åŠ¡ï¼Œåªè¦æ˜¯ä»»åŠ¡çš„ç›¸å·®æ—¶é—´ä¸æ˜¯å¾ˆé•¿ï¼Œæ•ˆç‡è‚¯å®šä¼šæ¯”æœªæ‹†åˆ†ä¹‹å‰è¦é«˜ã€‚</p> <ul><li><p>ä»»åŠ¡çš„ä¼˜å…ˆçº§</p></li> <li><p>ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´</p></li> <li><p>ä»»åŠ¡çš„ä¾èµ–æ€§</p></li> <li><p>æ˜¯å¦ä¾èµ–å…¶ä»–çš„ç³»ç»Ÿèµ„æºã€‚egï¼šæ•°æ®åº“è¿æ¥</p></li></ul> <h3 id="å¦‚ä½•å¯¹çº¿ç¨‹æ± è¿›è¡Œç›‘æ§"><a href="#å¦‚ä½•å¯¹çº¿ç¨‹æ± è¿›è¡Œç›‘æ§" class="header-anchor">#</a> å¦‚ä½•å¯¹çº¿ç¨‹æ± è¿›è¡Œç›‘æ§ï¼Ÿ</h3> <p>taskCountï¼šçº¿ç¨‹æ± éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡çš„æ•°é‡</p> <p>completedTaskCountï¼šçº¿ç¨‹æ± å·²ç»å®Œæˆçš„çº¿ç¨‹çš„æ•°é‡ï¼Œæ€»é‡åº”å°äºtaskCount</p> <p>largestPoolSizeï¼šçº¿ç¨‹æ± é‡Œæ›¾ç»åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œæ ¹æ®è¯¥å€¼å¯ä»¥çŸ¥é“çº¿ç¨‹æ± ä¹‹å‰æ˜¯å¦æ»¡è¿‡ï¼ŒåŠ å…¥largestPoolSizeç­‰äºçº¿ç¨‹æ± çš„æœ€å¤§å¤§å°ï¼Œè¯´æ˜ä¹‹å‰æ»¡è¿‡</p> <p>getPoolSizeï¼šçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ï¼Œåªè¦æ˜¯çº¿ç¨‹æ± ä¸é”€æ¯çš„è¯ï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œè¯¥å€¼åªå¢ä¸å‡</p> <p>getActiveCountï¼šè·å–æ´»åŠ¨çš„çº¿ç¨‹æ•°</p> <h2 id="concurrenthashmap"><a href="#concurrenthashmap" class="header-anchor">#</a> ConcurrentHashMap</h2> <h3 id="ç®€å•ä»‹ç»ä¸€ä¸‹-concurrenthashmap"><a href="#ç®€å•ä»‹ç»ä¸€ä¸‹-concurrenthashmap" class="header-anchor">#</a> ç®€å•ä»‹ç»ä¸€ä¸‹ ConcurrentHashMap</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>initialCapacity <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span>
               <span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">:</span>
               <span class="token function">tableSizeFor</span><span class="token punctuation">(</span>initialCapacity <span class="token operator">+</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sizeCtl <span class="token operator">=</span> cap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ConcurrentHashMap æ˜¯çº¿ç¨‹å®‰å…¨ä¸”é«˜æ•ˆçš„ HashMapï¼›</p> <p>ConcurrentHashMap åŒæ­¥å®¹å™¨ç±»æ˜¯ Java5 å¢åŠ çš„ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å“ˆå¸Œè¡¨ã€‚ä»‹äº HashMap ä¸ Hashtable ä¹‹é—´ã€‚å†…éƒ¨é‡‡ç”¨ <strong>â€é”åˆ†æ®µâ€œ æœºåˆ¶</strong>ä»£æ›¿<strong>Hashtable çš„ç‹¬å é”</strong>ï¼Œè¿›è€Œæé«˜æ€§èƒ½ã€‚</p> <h3 id="concurrenthashmap-å®ç°åŸç†"><a href="#concurrenthashmap-å®ç°åŸç†" class="header-anchor">#</a> ConcurrentHashMap å®ç°åŸç†</h3> <p><strong>JDK 1.8 ä¹‹å‰</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/BXuan-Yang/blogImage/img/image-20230318232428151.png" alt="image-20230318232428151"></p> <p><strong>JDK 1.8 ä¹‹å</strong></p> <p>CopyOnWriteArrayList / CopyOnWriteSet  &gt; å†™å…¥å¹¶å¤åˆ¶</p> <p><strong>æ³¨æ„ï¼šæ·»åŠ æ“ä½œå¤šæ—¶ï¼Œæ•ˆç‡ä½ã€‚å› ä¸ºæ¯æ¬¡æ·»åŠ æ—¶éƒ½ä¼šè¿›è¡Œå¤åˆ¶ï¼Œå¼€é”€éå¸¸å¤§ã€‚å¹¶å‘è¿­ä»£æ“ä½œå¤šæ—¶å¯ä»¥é€‰æ‹©ã€‚</strong></p> <p>ä¸‹é¢è¿›è¡Œä¸€ä¸ªç®€å•çš„ä¾‹å­ç¤ºèŒƒï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestCopyAndWriteArrayList</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread01</span> thread01 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>thread01<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Thread01</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

<span class="token comment">//    private static List&lt;String&gt; list = Collections.synchronizedList(new ArrayList&lt;&gt;());</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;AA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;BB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;CC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;DD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;AA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="å¤šçº¿ç¨‹"><a href="#å¤šçº¿ç¨‹" class="header-anchor">#</a> å¤šçº¿ç¨‹</h2> <h3 id="_1ã€ç¨‹åºã€è¿›ç¨‹ã€çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ"><a href="#_1ã€ç¨‹åºã€è¿›ç¨‹ã€çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ" class="header-anchor">#</a> 1ã€ç¨‹åºã€è¿›ç¨‹ã€çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ</h3> <ul><li>ç¨‹åº</li></ul> <p>ç¨‹åº(program)æ˜¯ä¸ºå®Œæˆç‰¹å®šä»»åŠ¡ã€ç”¨æŸç§è¯­è¨€ç¼–å†™çš„ä¸€ç»„æŒ‡ä»¤çš„é›†åˆã€‚</p> <p>å³æŒ‡ä¸€æ®µé™æ€çš„ä»£ç ï¼Œé™æ€å¯¹è±¡ã€‚</p> <ul><li>è¿›ç¨‹</li></ul> <p>è¿›ç¨‹(process)æ˜¯ç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œæˆ–æ˜¯æ­£åœ¨è¿è¡Œçš„ä¸€ä¸ªç¨‹åºã€‚</p> <p>æ˜¯ä¸€ä¸ªåŠ¨æ€çš„è¿‡ç¨‹ï¼šæœ‰å®ƒè‡ªèº«çš„äº§ç”Ÿã€å­˜åœ¨å’Œæ¶ˆäº¡çš„è¿‡ç¨‹ã€‚â€”â€”ç”Ÿå‘½å‘¨æœŸ</p> <p>å¦‚ï¼šè¿è¡Œä¸­çš„QQï¼Œè¿è¡Œä¸­çš„MP3æ’­æ”¾å™¨</p> <p><strong>ç¨‹åºæ˜¯é™æ€çš„ï¼Œè¿›ç¨‹æ˜¯åŠ¨æ€çš„</strong></p> <p>è¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„å•ä½ï¼Œç³»ç»Ÿåœ¨è¿è¡Œæ—¶ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸åŒçš„å†…å­˜åŒºåŸŸ</p> <ul><li>çº¿ç¨‹</li></ul> <p>çº¿ç¨‹(thread)ï¼Œè¿›ç¨‹å¯è¿›ä¸€æ­¥ç»†åŒ–ä¸ºçº¿ç¨‹ï¼Œæ˜¯ä¸€ä¸ªç¨‹åºå†…éƒ¨çš„ä¸€æ¡æ‰§è¡Œè·¯å¾„ã€‚</p> <p>è‹¥ä¸€ä¸ªè¿›ç¨‹åŒä¸€æ—¶é—´<strong>å¹¶è¡Œ</strong>æ‰§è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œå°±æ˜¯æ”¯æŒå¤šçº¿ç¨‹çš„</p> <p>çº¿ç¨‹ä½œä¸ºè°ƒåº¦å’Œæ‰§è¡Œçš„å•ä½ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„è¿è¡Œæ ˆå’Œç¨‹åºè®¡æ•°å™¨(pc)ï¼Œçº¿ç¨‹åˆ‡æ¢çš„å¼€é”€å°ã€‚</p> <p>ä¸€ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å…±äº«ç›¸åŒçš„å†…å­˜å•å…ƒ/å†…å­˜åœ°å€ç©ºé—´</p> <p>å®ƒä»¬ä»åŒä¸€å †ä¸­åˆ†é…å¯¹è±¡ï¼Œå¯ä»¥è®¿é—®ç›¸åŒçš„å˜é‡å’Œå¯¹è±¡ã€‚è¿™å°±ä½¿å¾—çº¿ç¨‹é—´é€šä¿¡æ›´ç®€ä¾¿ã€é«˜æ•ˆã€‚</p> <p>ä½†å¤šä¸ªçº¿ç¨‹æ“ä½œå…±äº«çš„ç³»ç»Ÿèµ„æºå¯èƒ½å°±ä¼šå¸¦æ¥å®‰å…¨çš„éšæ‚£ã€‚</p> <h3 id="_2ã€å¹¶å‘ä¸å¹¶è¡Œ"><a href="#_2ã€å¹¶å‘ä¸å¹¶è¡Œ" class="header-anchor">#</a> 2ã€å¹¶å‘ä¸å¹¶è¡Œ</h3> <p>**å¹¶è¡Œï¼š**å¤šä¸ªCPUåŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚æ¯”å¦‚ï¼šå¤šä¸ªäººåŒæ—¶åšä¸åŒçš„äº‹ã€‚</p> <p>**å¹¶å‘ï¼š**ä¸€ä¸ªCPU(é‡‡ç”¨æ—¶é—´ç‰‡)åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚æ¯”å¦‚ï¼šç§’æ€ã€å¤šä¸ªäººåšåŒä¸€ä»¶äº‹ã€‚</p> <h3 id="_3ã€å¤šçº¿ç¨‹çš„ä¼˜ç‚¹"><a href="#_3ã€å¤šçº¿ç¨‹çš„ä¼˜ç‚¹" class="header-anchor">#</a> 3ã€å¤šçº¿ç¨‹çš„ä¼˜ç‚¹</h3> <p>å¤šçº¿ç¨‹ç¨‹åºçš„ä¼˜ç‚¹ï¼š</p> <ol><li><p>**æé«˜åº”ç”¨ç¨‹åºçš„å“åº”ã€‚**å¯¹å›¾å½¢åŒ–ç•Œé¢æ›´æœ‰æ„ä¹‰ï¼Œå¯å¢å¼ºç”¨æˆ·ä½“éªŒã€‚</p></li> <li><p><strong>æé«˜è®¡ç®—æœºç³»ç»ŸCPUçš„åˆ©ç”¨ç‡</strong></p></li> <li><p><strong>æ”¹å–„ç¨‹åºç»“æ„</strong>ã€‚å°†æ—¢é•¿åˆå¤æ‚çš„è¿›ç¨‹åˆ†ä¸ºå¤šä¸ªçº¿ç¨‹ï¼Œç‹¬ç«‹è¿è¡Œï¼Œåˆ©äºç†è§£å’Œä¿®æ”¹</p></li></ol> <h3 id="_4ã€javaä¸­å¤šçº¿ç¨‹"><a href="#_4ã€javaä¸­å¤šçº¿ç¨‹" class="header-anchor">#</a> 4ã€Javaä¸­å¤šçº¿ç¨‹</h3> <p>åˆ›å»ºæ–°æ‰§è¡Œçº¿ç¨‹æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p> <ul><li>æ–¹å¼ä¸€ï¼šç»§æ‰¿Threadç±»</li></ul> <ol><li><p>å®šä¹‰å­ç±»ç»§æ‰¿Threadç±»ã€‚</p></li> <li><p>å­ç±»ä¸­é‡å†™Threadç±»ä¸­çš„runæ–¹æ³•ã€‚</p></li> <li><p>åˆ›å»ºThreadå­ç±»å¯¹è±¡ï¼Œå³åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ã€‚</p></li> <li><p>è°ƒç”¨çº¿ç¨‹å¯¹è±¡startæ–¹æ³•ï¼šå¯åŠ¨çº¿ç¨‹ï¼Œè°ƒç”¨runæ–¹æ³•ã€‚</p></li></ol> <ul><li>æ–¹å¼äºŒï¼šå®ç°Runnableæ¥å£</li></ul> <ol><li><p>å®šä¹‰å­ç±»ï¼Œå®ç°Runnableæ¥å£ã€‚</p></li> <li><p>å­ç±»ä¸­é‡å†™Runnableæ¥å£ä¸­çš„runæ–¹æ³•ã€‚</p></li> <li><p>é€šè¿‡Threadç±»å«å‚æ„é€ å™¨åˆ›å»ºçº¿ç¨‹å¯¹è±¡ã€‚</p></li> <li><p>å°†Runnableæ¥å£çš„å­ç±»å¯¹è±¡ä½œä¸ºå®é™…å‚æ•°ä¼ é€’ç»™Threadç±»çš„æ„é€ å™¨ä¸­ã€‚</p></li> <li><p>è°ƒç”¨Threadç±»çš„startæ–¹æ³•ï¼šå¼€å¯çº¿ç¨‹ï¼Œè°ƒç”¨Runnableå­ç±»æ¥å£çš„runæ–¹æ³•ã€‚</p></li></ol> <ul><li>ç»§æ‰¿æ–¹å¼ä¸å®ç°æ–¹å¼çš„åŒºåˆ«ä¸å¥½å¤„</li></ul> <p><strong>åŒºåˆ«</strong></p> <p>ç»§æ‰¿Threadï¼šçº¿ç¨‹ä»£ç å­˜æ”¾Threadå­ç±»runæ–¹æ³•ä¸­ã€‚</p> <p>å®ç°Runnableï¼šçº¿ç¨‹ä»£ç å­˜åœ¨æ¥å£çš„å­ç±»çš„runæ–¹æ³•ã€‚</p> <p><strong>å®ç°æ–¹å¼çš„å¥½å¤„</strong></p> <p>é¿å…äº†å•ç»§æ‰¿çš„å±€é™æ€§</p> <p>å¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ªæ¥å£å®ç°ç±»çš„å¯¹è±¡ï¼Œéå¸¸é€‚åˆå¤šä¸ªç›¸åŒçº¿ç¨‹æ¥å¤„ç†åŒä¸€ä»½èµ„æºã€‚</p> <h3 id="_5ã€çº¿ç¨‹çš„è°ƒåº¦"><a href="#_5ã€çº¿ç¨‹çš„è°ƒåº¦" class="header-anchor">#</a> 5ã€çº¿ç¨‹çš„è°ƒåº¦</h3> <ul><li>è°ƒåº¦ç­–ç•¥</li></ul> <p>æŠ¢å å¼ï¼šé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æŠ¢å CPU</p> <ul><li>Javaçš„è°ƒåº¦æ–¹æ³•</li></ul> <p>1ã€åŒä¼˜å…ˆçº§çº¿ç¨‹ç»„æˆå…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼ˆå…ˆåˆ°å…ˆæœåŠ¡ï¼‰ï¼Œä½¿ç”¨æ—¶é—´ç‰‡ç­–ç•¥</p> <p>2ã€å¯¹é«˜ä¼˜å…ˆçº§ï¼Œä½¿ç”¨ä¼˜å…ˆè°ƒåº¦çš„æŠ¢å å¼ç­–ç•¥</p> <ul><li>Javaä¸­å¤šçº¿ç¨‹çš„ä¼˜å…ˆçº§ç­‰çº§</li></ul> <p><strong>MAX_PRIORITYï¼š10</strong></p> <p><strong>MIN _PRIORITYï¼š1</strong></p> <p><strong>NORM_PRIORITYï¼š5</strong></p> <h3 id="_6ã€çº¿ç¨‹çš„åˆ†ç±»"><a href="#_6ã€çº¿ç¨‹çš„åˆ†ç±»" class="header-anchor">#</a> 6ã€çº¿ç¨‹çš„åˆ†ç±»</h3> <p>Javaä¸­çš„çº¿ç¨‹åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç§æ˜¯<strong>å®ˆæŠ¤çº¿ç¨‹</strong>ï¼Œä¸€ç§æ˜¯<strong>ç”¨æˆ·çº¿ç¨‹</strong>ã€‚</p> <p>å®ƒä»¬åœ¨å‡ ä¹æ¯ä¸ªæ–¹é¢éƒ½æ˜¯ç›¸åŒçš„ï¼Œ<strong>å”¯ä¸€çš„åŒºåˆ«æ˜¯åˆ¤æ–­JVMä½•æ—¶ç¦»å¼€ã€‚</strong></p> <p>å®ˆæŠ¤çº¿ç¨‹æ˜¯ç”¨æ¥æœåŠ¡ç”¨æˆ·çº¿ç¨‹çš„ï¼Œé€šè¿‡åœ¨start()æ–¹æ³•å‰è°ƒç”¨<strong>thread.setDaemon(true</strong>)å¯ä»¥æŠŠä¸€ä¸ªç”¨æˆ·çº¿ç¨‹å˜æˆä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ã€‚</p> <p>Javaåƒåœ¾å›æ”¶å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å®ˆæŠ¤çº¿ç¨‹ã€‚è‹¥JVMä¸­éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œå½“å‰JVMå°†é€€å‡ºã€‚</p> <p>å½¢è±¡ç†è§£ï¼šå…”æ­»ç‹—çƒ¹ï¼Œé¸Ÿå°½å¼“è—</p> <h3 id="_7ã€çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#_7ã€çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ" class="header-anchor">#</a> 7ã€çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h3> <p><strong>äº”ç§çŠ¶æ€</strong>ï¼š</p> <p><strong>æ–°å»ºï¼š</strong> å½“ä¸€ä¸ªThreadç±»æˆ–å…¶å­ç±»çš„å¯¹è±¡è¢«å£°æ˜å¹¶åˆ›å»ºæ—¶ï¼Œæ–°ç”Ÿçš„çº¿ç¨‹å¯¹è±¡å¤„äºæ–°å»ºçŠ¶æ€</p> <p>**å°±ç»ªï¼š**å¤„äºæ–°å»ºçŠ¶æ€çš„çº¿ç¨‹è¢«start()åï¼Œå°†è¿›å…¥çº¿ç¨‹é˜Ÿåˆ—ç­‰å¾…CPUæ—¶é—´ç‰‡ï¼Œæ­¤æ—¶å®ƒå·²å…·å¤‡äº†è¿è¡Œçš„æ¡ä»¶ï¼Œåªæ˜¯æ²¡åˆ†é…åˆ°CPUèµ„æº</p> <p>**è¿è¡Œï¼š**å½“å°±ç»ªçš„çº¿ç¨‹è¢«è°ƒåº¦å¹¶è·å¾—CPUèµ„æºæ—¶,ä¾¿è¿›å…¥è¿è¡ŒçŠ¶æ€ï¼Œrun()æ–¹æ³•å®šä¹‰äº†çº¿ç¨‹çš„æ“ä½œå’ŒåŠŸèƒ½</p> <p>**é˜»å¡ï¼š**åœ¨æŸç§ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œè¢«äººä¸ºæŒ‚èµ·æˆ–æ‰§è¡Œè¾“å…¥è¾“å‡ºæ“ä½œæ—¶ï¼Œè®©å‡º CPU å¹¶ä¸´æ—¶ä¸­æ­¢è‡ªå·±çš„æ‰§è¡Œï¼Œè¿›å…¥é˜»å¡çŠ¶æ€</p> <p>**æ­»äº¡ï¼š**çº¿ç¨‹å®Œæˆäº†å®ƒçš„å…¨éƒ¨å·¥ä½œæˆ–çº¿ç¨‹è¢«æå‰å¼ºåˆ¶æ€§åœ°ä¸­æ­¢æˆ–å‡ºç°å¼‚å¸¸å¯¼è‡´ç»“æŸ</p> <h3 id="_8ã€synchronizedçš„ä½¿ç”¨æ–¹æ³•"><a href="#_8ã€synchronizedçš„ä½¿ç”¨æ–¹æ³•" class="header-anchor">#</a> 8ã€Synchronizedçš„ä½¿ç”¨æ–¹æ³•</h3> <p>Javaå¯¹äºå¤šçº¿ç¨‹çš„å®‰å…¨é—®é¢˜æä¾›äº†ä¸“ä¸šçš„è§£å†³æ–¹å¼ï¼šåŒæ­¥æœºåˆ¶</p> <p><strong>1.</strong> <strong>åŒæ­¥ä»£ç å—ï¼š</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>å¯¹è±¡<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//éœ€è¦è¢«åŒæ­¥çš„ä»£ç ï¼›</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>2. synchronizedè¿˜å¯ä»¥æ”¾åœ¨æ–¹æ³•å£°æ˜ä¸­ï¼Œè¡¨ç¤ºæ•´ä¸ªæ–¹æ³•ä¸ºåŒæ­¥æ–¹æ³•ã€‚</strong></p> <p>ä¾‹å¦‚ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> show <span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">{</span>
	
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_9ã€åŒæ­¥é”æœºåˆ¶"><a href="#_9ã€åŒæ­¥é”æœºåˆ¶" class="header-anchor">#</a> 9ã€åŒæ­¥é”æœºåˆ¶</h3> <p>åœ¨ã€ŠThinking in Javaã€‹ä¸­ï¼Œæ˜¯è¿™ä¹ˆè¯´çš„ï¼šå¯¹äºå¹¶å‘å·¥ä½œï¼Œä½ éœ€è¦æŸç§æ–¹å¼æ¥é˜²æ­¢ä¸¤ä¸ªä»»åŠ¡è®¿é—®ç›¸åŒçš„èµ„æºï¼ˆå…¶å®å°±æ˜¯å…±äº«èµ„æºç«äº‰ï¼‰ã€‚</p> <p>é˜²æ­¢è¿™ç§å†²çªçš„æ–¹æ³•å°±æ˜¯å½“èµ„æºè¢«ä¸€ä¸ªä»»åŠ¡ä½¿ç”¨æ—¶ï¼Œåœ¨å…¶ä¸ŠåŠ é”ã€‚ç¬¬ä¸€ä¸ªè®¿é—®æŸé¡¹èµ„æºçš„ä»»åŠ¡å¿…é¡»é”å®šè¿™é¡¹èµ„æºï¼Œä½¿å…¶ä»–ä»»åŠ¡åœ¨å…¶è¢«è§£é”ä¹‹å‰ï¼Œå°±æ— æ³•è®¿é—®å®ƒäº†ï¼Œè€Œåœ¨å…¶è¢«è§£é”ä¹‹æ—¶ï¼Œå¦ä¸€ä¸ªä»»åŠ¡å°±å¯ä»¥é”å®šå¹¶ä½¿ç”¨å®ƒäº†ã€‚</p> <h3 id="_10ã€synchronizedé”"><a href="#_10ã€synchronizedé”" class="header-anchor">#</a> 10ã€synchronizedé”</h3> <p>ä»»æ„å¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºåŒæ­¥é”ã€‚</p> <p>æ‰€æœ‰å¯¹è±¡éƒ½è‡ªåŠ¨å«æœ‰å•ä¸€çš„é”ï¼ˆç›‘è§†å™¨ï¼‰ã€‚</p> <p>åŒæ­¥æ–¹æ³•çš„é”ï¼šé™æ€æ–¹æ³•ï¼ˆç±»å.classï¼‰ã€éé™æ€æ–¹æ³•ï¼ˆthisï¼‰</p> <p>åŒæ­¥ä»£ç å—ï¼šè‡ªå·±æŒ‡å®šï¼Œå¾ˆå¤šæ—¶å€™ä¹Ÿæ˜¯æŒ‡å®šä¸ºthisæˆ–ç±»å.class</p> <p><strong>æ³¨æ„ï¼š</strong></p> <p>1ã€å¿…é¡»ç¡®ä¿ä½¿ç”¨åŒä¸€ä¸ªèµ„æºçš„<strong>å¤šä¸ªçº¿ç¨‹å…±ç”¨ä¸€æŠŠé”</strong>ï¼Œè¿™ä¸ªéå¸¸é‡è¦ï¼Œå¦åˆ™å°±æ— æ³•ä¿è¯å…±äº«èµ„æºçš„å®‰å…¨</p> <p>2ã€ä¸€ä¸ªçº¿ç¨‹ç±»ä¸­çš„æ‰€æœ‰é™æ€æ–¹æ³•å…±ç”¨åŒä¸€æŠŠé”ï¼ˆç±»å.classï¼‰ï¼Œæ‰€æœ‰éé™æ€æ–¹æ³•å…±ç”¨åŒä¸€æŠŠé”ï¼ˆthisï¼‰ï¼ŒåŒæ­¥ä»£ç å—ï¼ˆæŒ‡å®šéœ€è°¨æ…ï¼‰</p> <h3 id="_11ã€locké”"><a href="#_11ã€locké”" class="header-anchor">#</a> 11ã€Locké”</h3> <p>ä»JDK 5.0å¼€å§‹ï¼ŒJavaæä¾›äº†æ›´å¼ºå¤§çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶â€”â€”é€šè¿‡æ˜¾å¼å®šä¹‰åŒæ­¥é”å¯¹è±¡æ¥å®ç°åŒæ­¥ã€‚</p> <p>åŒæ­¥é”ä½¿ç”¨Lockå¯¹è±¡å……å½“ã€‚</p> <p>java.util.concurrent.locks.Lockæ¥å£æ˜¯æ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¿›è¡Œè®¿é—®çš„å·¥å…·ã€‚é”æä¾›äº†å¯¹å…±äº«èµ„æºçš„ç‹¬å è®¿é—®ï¼Œæ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹Lockå¯¹è±¡åŠ é”ï¼Œçº¿ç¨‹å¼€å§‹è®¿é—®å…±äº«èµ„æºä¹‹å‰åº”å…ˆè·å¾—Lockå¯¹è±¡ã€‚</p> <p>ReentrantLock ç±»å®ç°äº† Lock ï¼Œå®ƒæ‹¥æœ‰ä¸ synchronized ç›¸åŒçš„å¹¶å‘æ€§å’Œå†…å­˜è¯­ä¹‰ï¼Œåœ¨å®ç°çº¿ç¨‹å®‰å…¨çš„æ§åˆ¶ä¸­ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ReentrantLockï¼Œå¯ä»¥æ˜¾å¼åŠ é”ã€é‡Šæ”¾é”</p> <p>æ³¨æ„ï¼šå¦‚æœåŒæ­¥ä»£ç æœ‰å¼‚å¸¸ï¼Œè¦å°†unlock()å†™å…¥finallyè¯­å¥å—</p> <h3 id="_12ã€synchronizedä¸lockçš„å¯¹æ¯”"><a href="#_12ã€synchronizedä¸lockçš„å¯¹æ¯”" class="header-anchor">#</a> 12ã€synchronizedä¸Lockçš„å¯¹æ¯”</h3> <ol><li><p>Lockæ˜¯æ˜¾å¼é”ï¼ˆæ‰‹åŠ¨å¼€å¯å’Œå…³é—­é”ï¼Œåˆ«å¿˜è®°å…³é—­é”ï¼‰ï¼Œsynchronizedæ˜¯éšå¼é”ï¼Œå‡ºäº†ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾</p></li> <li><p><strong>Lockåªæœ‰ä»£ç å—é”ï¼Œsynchronizedæœ‰ä»£ç å—é”å’Œæ–¹æ³•é”</strong></p></li> <li><p>ä½¿ç”¨Locké”ï¼ŒJVMå°†èŠ±è´¹è¾ƒå°‘çš„æ—¶é—´æ¥è°ƒåº¦çº¿ç¨‹ï¼Œæ€§èƒ½æ›´å¥½ã€‚å¹¶ä¸”å…·æœ‰æ›´å¥½çš„æ‰©å±•æ€§ï¼ˆæä¾›æ›´å¤šçš„å­ç±»ï¼‰</p></li></ol> <p><strong>ä¼˜å…ˆä½¿ç”¨é¡ºåºï¼š</strong></p> <p>Lock &gt; åŒæ­¥ä»£ç å—ï¼ˆå·²ç»è¿›å…¥äº†æ–¹æ³•ä½“ï¼Œåˆ†é…äº†ç›¸åº”èµ„æºï¼‰&gt; åŒæ­¥æ–¹æ³•ï¼ˆåœ¨æ–¹æ³•ä½“ä¹‹å¤–ï¼‰</p> <h3 id="_13ã€çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡"><a href="#_13ã€çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡" class="header-anchor">#</a> 13ã€çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡</h3> <p><strong>wait()</strong> <strong>ä¸</strong> <strong>notify()</strong> <strong>å’Œ</strong> <strong>notifyAll()</strong></p> <p><strong>wait()</strong>ï¼šä»¤å½“å‰çº¿ç¨‹æŒ‚èµ·å¹¶æ”¾å¼ƒCPUã€åŒæ­¥èµ„æºå¹¶ç­‰å¾…ï¼Œä½¿åˆ«çš„çº¿ç¨‹å¯è®¿é—®å¹¶ä¿®æ”¹å…±äº«èµ„æºï¼Œè€Œå½“å‰çº¿ç¨‹æ’é˜Ÿç­‰å€™å…¶ä»–çº¿ç¨‹è°ƒç”¨notify()æˆ–notifyAll()æ–¹æ³•å”¤é†’ï¼Œå”¤é†’åç­‰å¾…é‡æ–°è·å¾—å¯¹ç›‘è§†å™¨çš„æ‰€æœ‰æƒåæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</p> <p><strong>notify()</strong>ï¼šå”¤é†’æ­£åœ¨æ’é˜Ÿç­‰å¾…åŒæ­¥èµ„æºçš„çº¿ç¨‹ä¸­ä¼˜å…ˆçº§æœ€é«˜è€…ç»“æŸç­‰å¾…</p> <p><strong>notifyAll ()</strong>ï¼šå”¤é†’æ­£åœ¨æ’é˜Ÿç­‰å¾…èµ„æºçš„æ‰€æœ‰çº¿ç¨‹ç»“æŸç­‰å¾….</p> <p>è¿™ä¸‰ä¸ªæ–¹æ³•åªæœ‰åœ¨synchronizedæ–¹æ³•æˆ–synchronizedä»£ç å—ä¸­æ‰èƒ½ä½¿ç”¨ï¼Œå¦åˆ™ä¼šæŠ¥java.lang.IllegalMonitorStateExceptionå¼‚å¸¸ã€‚</p> <p>å› ä¸ºè¿™ä¸‰ä¸ªæ–¹æ³•å¿…é¡»æœ‰é”å¯¹è±¡è°ƒç”¨ï¼Œè€Œä»»æ„å¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºsynchronizedçš„åŒæ­¥é”ï¼Œå› æ­¤è¿™ä¸‰ä¸ªæ–¹æ³•åªèƒ½åœ¨Objectç±»ä¸­å£°æ˜ã€‚</p> <h3 id="_14ã€wait-ä¸-notify-å’Œ-notifyall"><a href="#_14ã€wait-ä¸-notify-å’Œ-notifyall" class="header-anchor">#</a> 14ã€<strong>wait()</strong> <strong>ä¸</strong> <strong>notify()</strong> <strong>å’Œ</strong> <strong>notifyAll()</strong></h3> <ul><li>wait()æ–¹æ³•</li></ul> <p>åœ¨å½“å‰çº¿ç¨‹ä¸­è°ƒç”¨æ–¹æ³•ï¼š å¯¹è±¡å.wait()</p> <p>ä½¿å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…ï¼ˆæŸå¯¹è±¡ï¼‰çŠ¶æ€ ï¼Œç›´åˆ°å¦ä¸€çº¿ç¨‹å¯¹è¯¥å¯¹è±¡å‘å‡º notify (æˆ–notifyAll) ä¸ºæ­¢ã€‚</p> <p>è°ƒç”¨æ–¹æ³•çš„å¿…è¦æ¡ä»¶ï¼šå½“å‰çº¿ç¨‹å¿…é¡»å…·æœ‰å¯¹è¯¥å¯¹è±¡çš„ç›‘æ§æƒï¼ˆåŠ é”ï¼‰</p> <p><strong>è°ƒç”¨æ­¤æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹å°†é‡Šæ”¾å¯¹è±¡ç›‘æ§æƒ ï¼Œç„¶åè¿›å…¥ç­‰å¾…</strong>åœ¨å½“å‰çº¿ç¨‹è¢«notifyåï¼Œè¦é‡æ–°è·å¾—ç›‘æ§æƒï¼Œç„¶åä»æ–­ç‚¹å¤„ç»§ç»­ä»£ç çš„æ‰§è¡Œã€‚</p> <ul><li>notify() / notifyAll()</li></ul> <p>åœ¨å½“å‰çº¿ç¨‹ä¸­è°ƒç”¨æ–¹æ³•ï¼š å¯¹è±¡å.notify()</p> <p>åŠŸèƒ½ï¼šå”¤é†’ç­‰å¾…è¯¥å¯¹è±¡ç›‘æ§æƒçš„ä¸€ä¸ª/æ‰€æœ‰çº¿ç¨‹ã€‚</p> <p>è°ƒç”¨æ–¹æ³•çš„å¿…è¦æ¡ä»¶ï¼šå½“å‰çº¿ç¨‹å¿…é¡»å…·æœ‰å¯¹è¯¥å¯¹è±¡çš„ç›‘æ§æƒï¼ˆåŠ é”ï¼‰</p> <h3 id="_15ã€callableæ¥å£"><a href="#_15ã€callableæ¥å£" class="header-anchor">#</a> 15ã€Callableæ¥å£</h3> <p>Futureæ¥å£å¯ä»¥å¯¹å…·ä½“Runnableã€Callableä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œå–æ¶ˆã€æŸ¥è¯¢æ˜¯å¦å®Œæˆã€è·å–ç»“æœç­‰ã€‚</p> <p>FutrueTaskæ˜¯Futrueæ¥å£çš„å”¯ä¸€çš„å®ç°ç±»</p> <p>FutureTask åŒæ—¶å®ç°äº†Runnable, Futureæ¥å£ã€‚å®ƒæ—¢å¯ä»¥ä½œä¸ºRunnableè¢«çº¿ç¨‹æ‰§è¡Œï¼Œåˆå¯ä»¥ä½œä¸ºFutureå¾—åˆ°Callableçš„è¿”å›å€¼</p> <h3 id="_16ã€ä½¿ç”¨çº¿ç¨‹æ± åŠçº¿ç¨‹æ± ç›¸å…³api"><a href="#_16ã€ä½¿ç”¨çº¿ç¨‹æ± åŠçº¿ç¨‹æ± ç›¸å…³api" class="header-anchor">#</a> 16ã€ä½¿ç”¨çº¿ç¨‹æ± åŠçº¿ç¨‹æ± ç›¸å…³API</h3> <p>**èƒŒæ™¯ï¼š**ç»å¸¸åˆ›å»ºå’Œé”€æ¯ã€ä½¿ç”¨é‡ç‰¹åˆ«å¤§çš„èµ„æºï¼Œæ¯”å¦‚å¹¶å‘æƒ…å†µä¸‹çš„çº¿ç¨‹ï¼Œå¯¹æ€§èƒ½å½±å“å¾ˆå¤§ã€‚</p> <p>**æ€è·¯ï¼š**æå‰åˆ›å»ºå¥½å¤šä¸ªçº¿ç¨‹ï¼Œæ”¾å…¥çº¿ç¨‹æ± ä¸­ï¼Œä½¿ç”¨æ—¶ç›´æ¥è·å–ï¼Œä½¿ç”¨å®Œæ”¾å›æ± ä¸­ã€‚å¯ä»¥é¿å…é¢‘ç¹åˆ›å»ºé”€æ¯ã€å®ç°é‡å¤åˆ©ç”¨ã€‚ç±»ä¼¼ç”Ÿæ´»ä¸­çš„å…¬å…±äº¤é€šå·¥å…·ã€‚</p> <p><strong>å¥½å¤„ï¼š</strong></p> <p>æé«˜å“åº”é€Ÿåº¦ï¼ˆå‡å°‘äº†åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶é—´ï¼‰</p> <p>é™ä½èµ„æºæ¶ˆè€—ï¼ˆé‡å¤åˆ©ç”¨çº¿ç¨‹æ± ä¸­çº¿ç¨‹ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½åˆ›å»ºï¼‰</p> <p>ä¾¿äºçº¿ç¨‹ç®¡ç†</p> <p>corePoolSizeï¼šæ ¸å¿ƒæ± çš„å¤§å°</p> <p>maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°</p> <p>keepAliveTimeï¼šçº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ—¶æœ€å¤šä¿æŒå¤šé•¿æ—¶é—´åä¼šç»ˆæ­¢</p> <h3 id="_17ã€çº¿ç¨‹æ± ç›¸å…³api"><a href="#_17ã€çº¿ç¨‹æ± ç›¸å…³api" class="header-anchor">#</a> 17ã€çº¿ç¨‹æ± ç›¸å…³API</h3> <p>JDK 5.0èµ·æä¾›äº†çº¿ç¨‹æ± ç›¸å…³APIï¼š<strong>ExecutorService</strong> å’Œ <strong>Executors</strong></p> <p>ExecutorServiceï¼šçœŸæ­£çš„çº¿ç¨‹æ± æ¥å£ã€‚å¸¸è§å­ç±»ThreadPoolExecutor</p> <p>void execute(Runnable command) ï¼šæ‰§è¡Œä»»åŠ¡/å‘½ä»¤ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬ç”¨æ¥æ‰§è¡ŒRunnable</p> <p>&lt; T &gt; Future&lt; T &gt; submit(Callable&lt; T &gt; task)ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œæœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬åˆæ¥æ‰§è¡ŒCallable</p> <p>void shutdown() ï¼šå…³é—­è¿æ¥æ± </p> <p>Executorsï¼šå·¥å…·ç±»ã€çº¿ç¨‹æ± çš„å·¥å‚ç±»ï¼Œç”¨äºåˆ›å»ºå¹¶è¿”å›ä¸åŒç±»å‹çš„çº¿ç¨‹æ± </p> <p>Executors.newCachedThreadPool()ï¼šåˆ›å»ºä¸€ä¸ªå¯æ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹çš„çº¿ç¨‹æ± </p> <p>Executors.newFixedThreadPool(n); åˆ›å»ºä¸€ä¸ªå¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± </p> <p>Executors.newSingleThreadExecutor() ï¼šåˆ›å»ºä¸€ä¸ªåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </p> <p>Executors.newScheduledThreadPool(n)ï¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå®ƒå¯å®‰æ’åœ¨ç»™å®šå»¶è¿Ÿåè¿è¡Œå‘½ä»¤æˆ–è€…å®šæœŸåœ°æ‰§è¡Œã€‚</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/blog/java/JavaGather.html" class="prev">
        Java é›†åˆ
      </a></span> <span class="next"><a href="/blog/java/JVM.html">
        JVM
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c7952645.js" defer></script><script src="/assets/js/2.53ba99d7.js" defer></script><script src="/assets/js/47.21cbd519.js" defer></script>
  </body>
</html>
